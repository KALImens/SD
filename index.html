<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="manifest" href="./manifest.json">
<meta name="theme-color" content="#00d4ff">
<link rel="icon" href="icons/icon-192.png" sizes="192x192">
    <title>Fahrzeug Manager</title>
    <style>
        :root {
            --primary: #00d4ff;
            --secondary: #9d4edd;
            --danger: #e53e3e;
            --success: #48bb78;
            --warning: #d69e2e;
            --dark-bg: #0a1929;
            --card-bg: #2d3748;
            --text-light: #ffffff;
            --text-muted: #a0aec0;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            min-height: 100vh;
            background: linear-gradient(135deg, #0a1929 0%, #1a202c 100%);
            color: var(--text-light);
            font-family: 'Arial', sans-serif;
            padding: 20px;
        }
        
        .container {
            max-width: 900px;
            margin: 0 auto;
        }
        
        .header {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .title {
            background: linear-gradient(135deg, #00d4ff 0%, #9d4edd 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            font-size: 42px;
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .sd-badge {
            background: linear-gradient(135deg, #9d4edd 0%, #00d4ff 100%);
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 600;
            display: inline-block;
        }
        
        .card {
            background: linear-gradient(135deg, #2d3748 0%, #4a5568 100%);
            border-radius: 16px;
            padding: 24px;
            margin-bottom: 20px;
            box-shadow: 0 8px 32px rgba(0, 212, 255, 0.1);
            border: 1px solid rgba(157, 78, 221, 0.3);
        }
        
        .button {
            border: none;
            border-radius: 12px;
            padding: 12px 20px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
            justify-content: center;
        }
        
        .button-primary {
            background: linear-gradient(135deg, #00d4ff 0%, #0099cc 100%);
            color: white;
        }
        
        .button-secondary {
            background: linear-gradient(135deg, #9d4edd 0%, #7b2cbf 100%);
            color: white;
        }
        
        .button-danger {
            background: linear-gradient(135deg, #e53e3e 0%, #c53030 100%);
            color: white;
        }
        
        .button-success {
            background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
            color: white;
        }
        
        .button-warning {
            background: linear-gradient(135deg, #d69e2e 0%, #b7791f 100%);
            color: white;
        }
        
        .button-small {
            padding: 8px 16px;
            font-size: 14px;
            border-radius: 10px;
        }
        
        .input, .textarea, .select {
            width: 100%;
            padding: 12px;
            border: 2px solid #4a5568;
            border-radius: 10px;
            background: #1a202c;
            color: white;
            font-size: 14px;
            transition: all 0.3s ease;
        }
        
        .input:focus, .textarea:focus, .select:focus {
            outline: none;
            border-color: #00d4ff;
            box-shadow: 0 0 0 3px rgba(0, 212, 255, 0.1);
        }
        
        .textarea {
            resize: vertical;
            min-height: 100px;
        }
        
        .vehicle-card {
            background: linear-gradient(135deg, #2d3748 0%, #4a5568 100%);
            border-radius: 14px;
            padding: 18px;
            margin-bottom: 14px;
            border: 1px solid rgba(157, 78, 221, 0.2);
            transition: all 0.3s ease;
        }
        
        .vehicle-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(157, 78, 221, 0.3);
        }
        
        .icon-button {
            background: none;
            border: none;
            cursor: pointer;
            font-size: 18px;
            padding: 6px;
            border-radius: 8px;
            transition: all 0.3s ease;
        }
        
        .icon-button:hover {
            background: rgba(0, 212, 255, 0.2);
            transform: scale(1.1);
        }
        
        .warning-badge {
            background: linear-gradient(135deg, #d69e2e 0%, #f6e05e 100%);
            color: #744210;
            padding: 4px 10px;
            border-radius: 16px;
            font-size: 12px;
            font-weight: 600;
            margin-top: 6px;
            display: inline-flex;
            align-items: center;
            gap: 4px;
        }
        
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.9);
            backdrop-filter: blur(10px);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            padding: 20px;
        }
        
        .modal-content {
            background: linear-gradient(135deg, #2d3748 0%, #4a5568 100%);
            border-radius: 20px;
            padding: 28px;
            width: 100%;
            max-width: 700px;
            max-height: 85vh;
            overflow: auto;
            border: 1px solid rgba(157, 78, 221, 0.4);
            box-shadow: 0 20px 60px rgba(0, 212, 255, 0.2);
        }
        
        .flex-row {
            display: flex;
            gap: 20px;
            margin-bottom: 16px;
            flex-wrap: wrap;
        }
        
        .flex-col {
            flex: 1;
            min-width: 120px;
        }
        
        .vehicle-actions {
            display: flex;
            gap: 6px;
            flex-wrap: wrap;
        }
        
        .vehicle-info {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
            margin-bottom: 6px;
        }
        
        .reminders-popup {
            position: fixed;
            right: 20px;
            top: 80px;
            width: 320px;
            z-index: 1200;
        }
        
        .reminders-content {
            padding: 12px;
            border-radius: 12px;
            background: #0b1220;
            border: 1px solid rgba(157, 78, 221, 0.4);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.6);
        }
        
        .reminder-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px;
            border-radius: 8px;
            background: #071022;
            margin-top: 8px;
        }
        
        .hidden {
            display: none;
        }
        
        .item-list {
            margin-top: 10px;
        }
        
        .item-entry {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            background: #1a202c;
            border-radius: 8px;
            margin-bottom: 6px;
            border: 1px solid rgba(0, 212, 255, 0.3);
        }
        
        .item-details {
            flex: 1;
        }
        
        .item-title {
            color: #00d4ff;
            font-weight: bold;
            font-size: 13px;
            margin-bottom: 4px;
        }
        
        .item-value {
            color: white;
            font-size: 13px;
        }
        
        .delete-item {
            background: none;
            border: none;
            color: #e53e3e;
            cursor: pointer;
            font-size: 14px;
            padding: 4px;
            border-radius: 4px;
        }
        
        .delete-item:hover {
            background: rgba(229, 62, 62, 0.2);
        }
        
        .edit-item {
            background: none;
            border: none;
            color: #00d4ff;
            cursor: pointer;
            font-size: 14px;
            padding: 4px;
            border-radius: 4px;
            margin-right: 5px;
        }
        
        .edit-item:hover {
            background: rgba(0, 212, 255, 0.2);
        }
        
        .form-row {
            display: flex;
            gap: 8px;
            margin-bottom: 14px;
        }
        
        .work-info {
            margin-top: 6px;
            font-size: 12px;
            color: #9d4edd;
        }
        
        .import-export-buttons {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-bottom: 20px;
        }
        
        .file-input {
            display: none;
        }
        
        .file-label {
            display: inline-block;
            padding: 8px 16px;
            background: linear-gradient(135deg, #9d4edd 0%, #7b2cbf 100%);
            color: white;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .file-label:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(157, 78, 221, 0.3);
        }
        
        .button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 212, 255, 0.4);
        }
        
        .button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        label {
            display: block;
            margin-bottom: 6px;
            font-weight: 600;
            font-size: 13px;
        }
        
        .work-edit-form {
            background: rgba(0, 212, 255, 0.1);
            border: 1px solid rgba(0, 212, 255, 0.3);
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 10px;
        }
        
        .work-actions {
            display: flex;
            gap: 5px;
            margin-top: 8px;
        }
        
        /* Service Checkliste Styles */
        .service-checklist {
            margin-top: 16px;
        }
        
        .service-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            background: #1a202c;
            border-radius: 8px;
            margin-bottom: 8px;
            border: 1px solid rgba(157, 78, 221, 0.2);
            transition: all 0.3s ease;
        }
        
        .service-item:hover {
            border-color: #00d4ff;
            background: #1f2937;
        }
        
        .service-item-name {
            color: #e2e8f0;
            font-weight: 500;
            font-size: 14px;
        }
        
        .service-toggle {
            display: flex;
            gap: 8px;
        }
        
        .toggle-option {
            padding: 6px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 600;
            transition: all 0.3s ease;
            border: 1px solid #4a5568;
        }
        
        .toggle-option.yes {
            background: #1a202c;
            color: #a0aec0;
        }
        
        .toggle-option.yes.selected {
            background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
            color: white;
            border-color: #48bb78;
        }
        
        .toggle-option.no {
            background: #1a202c;
            color: #a0aec0;
        }
        
        .toggle-option.no.selected {
            background: linear-gradient(135deg, #e53e3e 0%, #c53030 100%);
            color: white;
            border-color: #e53e3e;
        }
        
        .service-summary {
            margin-top: 20px;
            padding: 16px;
            background: rgba(0, 212, 255, 0.1);
            border-radius: 8px;
            border: 1px solid rgba(0, 212, 255, 0.3);
        }
        
        .service-summary h4 {
            color: #00d4ff;
            margin-bottom: 8px;
            font-size: 16px;
        }
        
        .service-summary-list {
            font-size: 13px;
            color: #e2e8f0;
        }
        
        .service-summary-item {
            margin-bottom: 4px;
            padding-left: 8px;
        }

        /* Service Details Styles */
        .service-details {
            margin-top: 8px;
            padding: 8px;
            background: rgba(157, 78, 221, 0.1);
            border-radius: 6px;
            border: 1px solid rgba(157, 78, 221, 0.3);
        }
        
        .service-detail-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 4px;
            font-size: 12px;
        }
        
        .service-detail-name {
            color: #9d4edd;
        }
        
        .service-detail-value {
            color: #00d4ff;
            font-weight: 600;
        }
        
        /* Service Intervall Styles */
        .service-interval {
            margin-top: 16px;
            padding: 16px;
            background: rgba(157, 78, 221, 0.1);
            border-radius: 8px;
            border: 1px solid rgba(157, 78, 221, 0.3);
        }
        
        .service-interval h4 {
            color: #9d4edd;
            margin-bottom: 8px;
            font-size: 16px;
        }
        
        .interval-options {
            display: flex;
            gap: 10px;
            margin-bottom: 12px;
        }
        
        .interval-option {
            flex: 1;
            padding: 10px;
            border-radius: 8px;
            background: #1a202c;
            border: 1px solid #4a5568;
            cursor: pointer;
            text-align: center;
            transition: all 0.3s ease;
        }
        
        .interval-option:hover {
            border-color: #9d4edd;
        }
        
        .interval-option.selected {
            background: rgba(157, 78, 221, 0.2);
            border-color: #9d4edd;
            color: #9d4edd;
        }
        
        .next-service-info {
            margin-top: 12px;
            padding: 10px;
            background: rgba(0, 212, 255, 0.1);
            border-radius: 6px;
            border: 1px solid rgba(0, 212, 255, 0.3);
        }
        
        .next-service-info h5 {
            color: #00d4ff;
            margin-bottom: 6px;
            font-size: 14px;
        }
        
        .next-service-details {
            font-size: 13px;
            color: #e2e8f0;
        }
        
        .urgent-reminder {
            background: rgba(214, 158, 46, 0.2);
            border: 1px solid rgba(214, 158, 46, 0.5);
            color: #f6e05e;
        }
        
        /* Service Actions mit Icons */
        .service-actions {
            display: flex;
            gap: 8px;
            margin-top: 10px;
        }
        
        .service-action-button {
            background: none;
            border: none;
            cursor: pointer;
            font-size: 16px;
            padding: 6px;
            border-radius: 6px;
            transition: all 0.3s ease;
        }
        
        .service-edit {
            color: #00d4ff;
        }
        
        .service-edit:hover {
            background: rgba(0, 212, 255, 0.2);
            transform: scale(1.1);
        }
        
        .service-delete {
            color: #e53e3e;
        }
        
        .service-delete:hover {
            background: rgba(229, 62, 62, 0.2);
            transform: scale(1.1);
        }
        
        /* Service Item Actions */
        .service-item-actions {
            display: flex;
            gap: 6px;
            margin-left: 10px;
        }
        
        /* Service Modal Icon Buttons */
        .service-modal-actions {
            display: flex;
            gap: 10px;
            margin-top: 20px;
            justify-content: center;
        }
        
        .service-modal-button {
            background: none;
            border: none;
            cursor: pointer;
            font-size: 20px;
            padding: 10px;
            border-radius: 8px;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 44px;
            height: 44px;
        }
        
        .service-modal-button:hover {
            transform: scale(1.1);
        }
        
        .service-save {
            background: rgba(0, 212, 255, 0.2);
            color: #00d4ff;
            border: 1px solid rgba(0, 212, 255, 0.4);
        }
        
        .service-save:hover {
            background: rgba(0, 212, 255, 0.3);
        }
        
        .service-delete-modal {
            background: rgba(229, 62, 62, 0.2);
            color: #e53e3e;
            border: 1px solid rgba(229, 62, 62, 0.4);
        }
        
        .service-delete-modal:hover {
            background: rgba(229, 62, 62, 0.3);
        }
        
        .service-cancel {
            background: rgba(160, 174, 192, 0.2);
            color: #a0aec0;
            border: 1px solid rgba(160, 174, 192, 0.4);
        }
        
        .service-cancel:hover {
            background: rgba(160, 174, 192, 0.3);
        }

        /* Calculator Styles */
        .calculator-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 16px;
            background: #1a202c;
            border-radius: 8px;
            overflow: hidden;
        }
        
        .calculator-table th {
            background: linear-gradient(135deg, #9d4edd 0%, #7b2cbf 100%);
            color: white;
            padding: 12px 8px;
            text-align: left;
            font-weight: 600;
            font-size: 13px;
        }
        
        .calculator-table td {
            padding: 10px 8px;
            border-bottom: 1px solid #2d3748;
            font-size: 13px;
        }
        
        .calculator-table tr:last-child td {
            border-bottom: none;
        }
        
        .calculator-table tr:hover {
            background: #2d3748;
        }
        
        .calculator-input {
            width: 100%;
            background: transparent;
            border: 1px solid #4a5568;
            border-radius: 4px;
            padding: 6px 8px;
            color: white;
            font-size: 13px;
        }
        
        .calculator-input:focus {
            outline: none;
            border-color: #00d4ff;
        }
        
        .calculator-total-row {
            background: rgba(0, 212, 255, 0.1) !important;
            font-weight: 600;
        }
        
        .calculator-total-row td {
            border-top: 2px solid #00d4ff;
        }
        
        .calculator-actions {
            display: flex;
            gap: 10px;
            margin-top: 16px;
        }
        
        .calculator-summary {
            margin-top: 16px;
            padding: 12px;
            background: rgba(157, 78, 221, 0.1);
            border-radius: 8px;
            border: 1px solid rgba(157, 78, 221, 0.3);
        }
        
        .calculator-summary-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 6px;
            font-size: 13px;
        }
        
        .calculator-summary-label {
            color: #9d4edd;
        }
        
        .calculator-summary-value {
            color: #00d4ff;
            font-weight: 600;
        }
        
        .saved-calculations {
            margin-top: 20px;
        }
        
        .saved-calculation-item {
            background: #1a202c;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 10px;
            border: 1px solid rgba(0, 212, 255, 0.3);
        }
        
        .saved-calculation-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }
        
        .saved-calculation-title {
            color: #00d4ff;
            font-weight: 600;
            font-size: 14px;
        }
        
        .saved-calculation-date {
            color: #9d4edd;
            font-size: 12px;
        }
        
        .saved-calculation-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 12px;
        }
        
        .saved-calculation-table th {
            background: rgba(157, 78, 221, 0.2);
            color: #9d4edd;
            padding: 6px 4px;
            text-align: left;
            font-weight: 600;
        }
        
        .saved-calculation-table td {
            padding: 6px 4px;
            border-bottom: 1px solid #2d3748;
        }
        
        .saved-calculation-total {
            background: rgba(0, 212, 255, 0.1);
            font-weight: 600;
        }
        
        .delete-calculation {
            background: none;
            border: none;
            color: #e53e3e;
            cursor: pointer;
            font-size: 14px;
            padding: 4px 8px;
            border-radius: 4px;
        }
        
        .delete-calculation:hover {
            background: rgba(229, 62, 62, 0.2);
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1 class="title">üöó Fahrzeug Manager</h1>
            <div class="sd-badge">SD</div>
            <button id="reminders-button" title="Erinnerungen" style="margin-left:12px; background:none; border:none; color:white; cursor:pointer; font-size:20px">
                üîî<span id="reminders-count"></span>
            </button>
        </div>

        <!-- Import/Export Buttons -->
        <div class="import-export-buttons">
            <button id="export-data" class="button button-success button-small">
                <span style="font-size: 16px">üì§</span>
                Export
            </button>
            
            <label for="import-file" class="file-label">
                <span style="font-size: 16px">üì•</span>
                Import
            </label>
            <input type="file" id="import-file" class="file-input" accept=".json">
        </div>

        <!-- Eingabeformular -->
        <div class="card">
            <h2 style="color: #00d4ff; margin-bottom: 20px; font-size: 22px; display: flex; align-items: center; gap: 8px">
                <span style="font-size: 24px">üìù</span>
                Neues Fahrzeug
            </h2>

            <!-- HSN/TSN Reihe -->
            <div class="flex-row">
                <div class="flex-col">
                    <label style="color: #00d4ff;">
                        HSN *
                    </label>
                    <input
                        type="text"
                        id="hsn-input"
                        placeholder="1234"
                        maxlength="4"
                        class="input"
                    />
                </div>

                <div class="flex-col">
                    <label style="color: #00d4ff;">
                        TSN *
                    </label>
                    <input
                        id="tsn-input"
                        type="text"
                        placeholder="AB1"
                        maxlength="3"
                        class="input"
                    />
                </div>

                <div class="flex-col">
                    <label style="color: #9d4edd;">
                        Kennzeichen
                    </label>
                    <input
                        type="text"
                        id="license-plate-input"
                        placeholder="M-AB 123"
                        class="input"
                    />
                </div>
            </div>

            <!-- FIN Reihe -->
            <div style="margin-bottom: 16px">
                <label style="color: #00d4ff;">
                    FIN (17 Zeichen) *
                </label>
                <input
                    type="text"
                    id="fin-input"
                    placeholder="W0L00000000000000"
                    maxlength="17"
                    class="input"
                />
            </div>

            <!-- Kilometerstand -->
            <div style="margin-bottom: 16px">
                <label style="color: #00d4ff;">
                    Kilometerstand
                </label>
                <input
                    type="text"
                    id="mileage-input"
                    placeholder="z.B. 152000"
                    class="input"
                />
            </div>

            <!-- Modell/Erstzulassung Reihe -->
            <div class="flex-row">
                <div class="flex-col" style="flex: 2 1 200px">
                    <label style="color: #9d4edd;">
                        Modell
                    </label>
                    <input
                        type="text"
                        id="model-input"
                        placeholder="Golf VII 2.0 TDI"
                        class="input"
                    />
                </div>

                <div class="flex-col" style="flex: 1 1 140px">
                    <label style="color: #9d4edd;">
                        Erstzulassung
                    </label>
                    <input
                        type="date"
                        id="first-registration-input"
                        class="input"
                    />
                </div>
            </div>

            <button
                id="add-vehicle-button"
                class="button button-primary"
                style="width: 100%; opacity: 0.6"
            >
                <span style="font-size: 18px">üíæ</span>
                Fahrzeug speichern
            </button>
        </div>

        <!-- Fahrzeugliste -->
        <div>
            <h2 style="color: #9d4edd; margin-bottom: 16px; font-size: 22px; display: flex; align-items: center; gap: 8px">
                <span style="font-size: 24px">üìã</span>
                Gespeicherte Fahrzeuge (<span id="vehicle-count">0</span>)
            </h2>

            <div id="vehicle-list">
                <!-- Fahrzeuge werden hier dynamisch eingef√ºgt -->
            </div>
        </div>
    </div>

    <!-- Reminders Popup -->
    <div id="reminders-popup" class="reminders-popup hidden">
        <div class="reminders-content">
            <h4 style="margin:0; color:#00d4ff">üîî Erinnerungen</h4>
            <div id="reminders-list" style="max-height:300px; overflow:auto; margin-top:8px">
                <!-- Erinnerungen werden hier dynamisch eingef√ºgt -->
            </div>
            <div style="display:flex; gap:8px; margin-top:10px">
                <button id="clear-all-reminders" style="padding:8px; border-radius:8px; background:#e53e3e; color:white; border:none">Alle l√∂schen</button>
                <button id="close-reminders" style="padding:8px; border-radius:8px; background:transparent; border:1px solid rgba(157,78,221,0.4); color:white">Schlie√üen</button>
            </div>
        </div>
    </div>

    <!-- Modals -->
    <div id="modal-container">
        <!-- Modals werden hier dynamisch eingef√ºgt -->
    </div>

    <script>
        // Datenklassen
        class Vehicle {
            constructor(data = {}) {
                this.id = data.id || Date.now().toString();
                this.hsn = data.hsn || '';
                this.tsn = data.tsn || '';
                this.fin = data.fin || '';
                this.licensePlate = data.licensePlate || '';
                this.model = data.model || '';
                this.firstRegistration = data.firstRegistration || '';
                this.mileage = data.mileage || '';
                this.notes = data.notes || '';
                this.images = data.images || [];
                this.torqueValues = data.torqueValues || [];
                this.parts = data.parts || [];
                this.customFields = data.customFields || [];
                this.executedWorks = data.executedWorks || [];
                this.services = data.services || [];
                this.nextServiceDate = data.nextServiceDate || '';
                this.serviceInterval = data.serviceInterval || 1; // 1 oder 2 Jahre
            }
        }

        class VehicleImage {
            constructor(data = {}) {
                this.id = data.id || Date.now().toString();
                this.name = data.name || '';
                this.data = data.data || ''; // Base64 encoded image data
                this.uploadDate = data.uploadDate || new Date().toISOString();
            }
        }

        class TorqueValue {
            constructor(data = {}) {
                this.id = data.id || Date.now().toString();
                this.description = data.description || '';
                this.value = data.value || '';
            }
        }

        class Part {
            constructor(data = {}) {
                this.id = data.id || Date.now().toString();
                this.description = data.description || '';
                this.oeNumber = data.oeNumber || '';
            }
        }

        class CustomField {
            constructor(data = {}) {
                this.id = data.id || Date.now().toString();
                this.title = data.title || '';
                this.value = data.value || '';
            }
        }

        class ExecutedWork {
            constructor(data = {}) {
                this.id = data.id || Date.now().toString();
                this.description = data.description || '';
                this.date = data.date || '';
            }
        }

        class Service {
            constructor(data = {}) {
                this.id = data.id || Date.now().toString();
                this.date = data.date || '';
                this.mileage = data.mileage || '';
                this.items = data.items || {};
                this.notes = data.notes || '';
            }
        }

        class Reminder {
            constructor(data = {}) {
                this.id = data.id || Date.now().toString();
                this.vehicleId = data.vehicleId || '';
                this.title = data.title || '';
                this.dueDate = data.dueDate || '';
                this.createdAt = data.createdAt || new Date().toISOString();
                this.done = data.done || false;
                this.type = data.type || 'service'; // 'service' oder 'general'
            }
        }

        // Neue Klasse f√ºr gespeicherte Preisberechnungen
        class PriceCalculation {
            constructor(data = {}) {
                this.id = data.id || Date.now().toString();
                this.vehicleId = data.vehicleId || '';
                this.title = data.title || '';
                this.date = data.date || new Date().toISOString();
                this.items = data.items || [];
                this.totalParts = data.totalParts || 0;
                this.totalAW = data.totalAW || 0;
                this.grandTotal = data.grandTotal || 0;
            }
        }

        // Service-Items Definition
        const SERVICE_ITEMS = [
            { id: 'motorOil', name: 'Motor√∂l' },
            { id: 'oilFilter', name: '√ñlfilter' },
            { id: 'gearboxOil', name: 'Getriebe√∂l' },
            { id: 'airFilter', name: 'Luftfilter' },
            { id: 'cabinFilter', name: 'Reinluftfilter (Innenraumfilter)' },
            { id: 'fuelFilter', name: 'Kraftstofffilter' },
            { id: 'sparkPlugs', name: 'Z√ºndkerzen' },
            { id: 'glowPlugs', name: 'Gl√ºhkerzen' },
            { id: 'brakeFluid', name: 'Bremsfl√ºssigkeit' },
            { id: 'timingBelt', name: 'Zahnriemen' },
            { id: 'vBelt', name: 'Rillenriemen (Keilriemen)' },
            { id: 'coolant', name: 'K√ºhlfl√ºssigkeit' }
        ];

        // Hilfsfunktionen
        function loadReminders() {
            try {
                const raw = localStorage.getItem('reminders');
                if (!raw) return [];
                return JSON.parse(raw);
            } catch (e) {
                console.error('loadReminders', e);
                return [];
            }
        }

        function saveReminders(r) {
            try {
                localStorage.setItem('reminders', JSON.stringify(r));
            } catch (e) {
                console.error('saveReminders', e);
            }
        }

        function createReminder(vehicleId, title, dueDate, type = 'service') {
            return new Reminder({
                vehicleId,
                title,
                dueDate,
                type
            });
        }

        // Datum-Funktionen f√ºr Service-Intervalle
        function addYearsToDate(date, years) {
            const result = new Date(date);
            result.setFullYear(result.getFullYear() + years);
            return result;
        }

        function subtractDaysFromDate(date, days) {
            const result = new Date(date);
            result.setDate(result.getDate() - days);
            return result;
        }

        function formatDateForInput(date) {
            return date.toISOString().split('T')[0];
        }

        function formatDateForDisplay(date) {
            return new Date(date).toLocaleDateString('de-DE');
        }

        // Import/Export Funktionen
        function exportData() {
            const vehicles = JSON.parse(localStorage.getItem('vehicles') || '[]');
            const reminders = loadReminders();
            
            const exportData = {
                vehicles: vehicles,
                reminders: reminders,
                exportDate: new Date().toISOString(),
                version: '1.0'
            };
            
            const dataStr = JSON.stringify(exportData, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `fahrzeug-manager-${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
            
            showNotification('‚úÖ Daten erfolgreich exportiert!', 'success');
        }

        function importData(file) {
            const reader = new FileReader();
            
            reader.onload = function(e) {
                try {
                    const importData = JSON.parse(e.target.result);
                    
                    // Validierung der Import-Daten
                    if (!importData.vehicles || !Array.isArray(importData.vehicles)) {
                        throw new Error('Ung√ºltiges Dateiformat: Keine Fahrzeugdaten gefunden');
                    }
                    
                    if (confirm(`M√∂chten Sie ${importData.vehicles.length} Fahrzeuge und ${importData.reminders?.length || 0} Erinnerungen importieren? Vorhandene Daten werden √ºberschrieben.`)) {
                        // Daten speichern
                        localStorage.setItem('vehicles', JSON.stringify(importData.vehicles));
                        if (importData.reminders) {
                            saveReminders(importData.reminders);
                        }
                        
                        showNotification('‚úÖ Daten erfolgreich importiert!', 'success');
                        
                        // Seite neu laden um Daten anzuzeigen
                        setTimeout(() => {
                            window.location.reload();
                        }, 1000);
                    }
                } catch (error) {
                    console.error('Import error:', error);
                    showNotification('‚ùå Fehler beim Import: ' + error.message, 'error');
                }
            };
            
            reader.onerror = function() {
                showNotification('‚ùå Fehler beim Lesen der Datei', 'error');
            };
            
            reader.readAsText(file);
        }

        function showNotification(message, type = 'info') {
            // Existierende Notification entfernen
            const existingNotification = document.getElementById('notification');
            if (existingNotification) {
                existingNotification.remove();
            }
            
            const notification = document.createElement('div');
            notification.id = 'notification';
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 16px 20px;
                border-radius: 12px;
                color: white;
                font-weight: 600;
                z-index: 10000;
                box-shadow: 0 8px 25px rgba(0,0,0,0.3);
                transform: translateX(400px);
                transition: transform 0.3s ease;
                max-width: 300px;
                background: ${type === 'success' ? 'linear-gradient(135deg, #48bb78 0%, #38a169 100%)' : 
                             type === 'error' ? 'linear-gradient(135deg, #e53e3e 0%, #c53030 100%)' :
                             'linear-gradient(135deg, #00d4ff 0%, #0099cc 100%)'};
            `;
            
            notification.textContent = message;
            document.body.appendChild(notification);
            
            // Animation einblenden
            setTimeout(() => {
                notification.style.transform = 'translateX(0)';
            }, 100);
            
            // Nach 3 Sekunden ausblenden
            setTimeout(() => {
                notification.style.transform = 'translateX(400px)';
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.parentNode.removeChild(notification);
                    }
                }, 300);
            }, 3000);
        }

        // Bildverwaltung Funktionen
        function compressImage(file, maxWidth = 800, maxHeight = 800, quality = 0.7) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const img = new Image();
                    img.onload = function() {
                        const canvas = document.createElement('canvas');
                        let width = img.width;
                        let height = img.height;

                        // Berechne neue Gr√∂√üe
                        if (width > height) {
                            if (width > maxWidth) {
                                height = Math.round((height * maxWidth) / width);
                                width = maxWidth;
                            }
                        } else {
                            if (height > maxHeight) {
                                width = Math.round((width * maxHeight) / height);
                                height = maxHeight;
                            }
                        }

                        canvas.width = width;
                        canvas.height = height;

                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, width, height);

                        // Konvertiere zu Base64
                        const base64 = canvas.toDataURL('image/jpeg', quality);
                        resolve(base64);
                    };
                    img.onerror = reject;
                    img.src = e.target.result;
                };
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        }

        // Hauptanwendungslogik
        class VehicleManager {
            constructor() {
                this.vehicles = [];
                this.reminders = [];
                this.priceCalculations = [];
                this.currentModal = null;
                this.editingWorkId = null;
                this.editingServiceId = null;
                
                this.init();
            }
            
            init() {
                this.loadVehicles();
                this.loadReminders();
                this.loadPriceCalculations();
                this.bindEvents();
                this.renderVehicleList();
                this.updateRemindersCount();
                this.checkUpcomingServices();
            }
            
            loadVehicles() {
                try {
                    const saved = localStorage.getItem('vehicles');
                    if (saved) {
                        const parsed = JSON.parse(saved);
                        this.vehicles = parsed.map(v => new Vehicle(v));
                    }
                } catch (e) {
                    console.error('Fehler beim Laden der Fahrzeuge', e);
                }
            }
            
            saveVehicles() {
                localStorage.setItem('vehicles', JSON.stringify(this.vehicles));
            }
            
            loadReminders() {
                this.reminders = loadReminders();
            }
            
            loadPriceCalculations() {
                try {
                    const saved = localStorage.getItem('priceCalculations');
                    if (saved) {
                        const parsed = JSON.parse(saved);
                        this.priceCalculations = parsed.map(pc => new PriceCalculation(pc));
                    }
                } catch (e) {
                    console.error('Fehler beim Laden der Preisberechnungen', e);
                }
            }
            
            savePriceCalculations() {
                localStorage.setItem('priceCalculations', JSON.stringify(this.priceCalculations));
            }
            
            bindEvents() {
                // HSN Validierung und Fokus-Wechsel
                document.getElementById('hsn-input').addEventListener('input', (e) => {
                    const value = e.target.value.replace(/\D/g, '').slice(0, 4);
                    e.target.value = value;
                    if (value.length === 4) {
                        document.getElementById('tsn-input').focus();
                    }
                    this.updateAddButtonState();
                });
                
                // TSN Validierung
                document.getElementById('tsn-input').addEventListener('input', (e) => {
                    const value = e.target.value.toUpperCase().slice(0, 3);
                    e.target.value = value;
                    this.updateAddButtonState();
                });
                
                // FIN Validierung
                document.getElementById('fin-input').addEventListener('input', (e) => {
                    const value = e.target.value.toUpperCase().slice(0, 17);
                    e.target.value = value;
                    this.updateAddButtonState();
                });
                
                // Kennzeichen Validierung
                document.getElementById('license-plate-input').addEventListener('input', (e) => {
                    const value = e.target.value.toUpperCase().replace(/[^A-Z0-9- ]/g, '');
                    e.target.value = value;
                });
                
                // Kilometerstand Validierung
                document.getElementById('mileage-input').addEventListener('input', (e) => {
                    const value = e.target.value.replace(/\D/g, '').slice(0, 7);
                    e.target.value = value;
                });
                
                // Fahrzeug hinzuf√ºgen
                document.getElementById('add-vehicle-button').addEventListener('click', () => {
                    this.addVehicle();
                });
                
                // Erinnerungen Popup
                document.getElementById('reminders-button').addEventListener('click', () => {
                    this.toggleRemindersPopup();
                });
                
                document.getElementById('close-reminders').addEventListener('click', () => {
                    this.hideRemindersPopup();
                });
                
                document.getElementById('clear-all-reminders').addEventListener('click', () => {
                    if (confirm('Alle Erinnerungen l√∂schen?')) {
                        this.reminders = [];
                        saveReminders(this.reminders);
                        this.renderRemindersList();
                        this.updateRemindersCount();
                    }
                });
                
                // Import/Export Events
                document.getElementById('export-data').addEventListener('click', exportData);
                document.getElementById('import-file').addEventListener('change', (e) => {
                    if (e.target.files.length > 0) {
                        importData(e.target.files[0]);
                        e.target.value = ''; // Reset file input
                    }
                });
                
                // Enter-Taste f√ºr Formular
                document.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter' && this.isFormValid()) {
                        this.addVehicle();
                    }
                });
            }
            
            updateAddButtonState() {
                const button = document.getElementById('add-vehicle-button');
                button.disabled = !this.isFormValid();
                button.style.opacity = this.isFormValid() ? 1 : 0.6;
            }
            
            isFormValid() {
                const hsn = document.getElementById('hsn-input').value;
                const tsn = document.getElementById('tsn-input').value;
                const fin = document.getElementById('fin-input').value;
                return hsn.length === 4 && tsn.length === 3 && fin.length === 17;
            }
            
            addVehicle() {
                if (!this.isFormValid()) return;
                
                const hsn = document.getElementById('hsn-input').value;
                const tsn = document.getElementById('tsn-input').value;
                const fin = document.getElementById('fin-input').value;
                const licensePlate = document.getElementById('license-plate-input').value;
                const model = document.getElementById('model-input').value;
                const firstRegistration = document.getElementById('first-registration-input').value;
                const mileage = document.getElementById('mileage-input').value;
                
                const newVehicle = new Vehicle({
                    hsn,
                    tsn,
                    fin,
                    licensePlate: licensePlate.trim(),
                    model: model.trim(),
                    firstRegistration,
                    mileage: mileage.trim()
                });
                
                this.vehicles.push(newVehicle);
                this.saveVehicles();
                this.renderVehicleList();
                this.clearForm();
                showNotification('‚úÖ Fahrzeug erfolgreich hinzugef√ºgt!', 'success');
            }
            
            clearForm() {
                document.getElementById('hsn-input').value = '';
                document.getElementById('tsn-input').value = '';
                document.getElementById('fin-input').value = '';
                document.getElementById('license-plate-input').value = '';
                document.getElementById('model-input').value = '';
                document.getElementById('first-registration-input').value = '';
                document.getElementById('mileage-input').value = '';
                this.updateAddButtonState();
            }
            
            deleteVehicle(id) {
                if (confirm('‚ö†Ô∏è M√∂chten Sie dieses Fahrzeug wirklich l√∂schen?')) {
                    this.vehicles = this.vehicles.filter(v => v.id !== id);
                    this.saveVehicles();
                    this.renderVehicleList();
                    showNotification('üóëÔ∏è Fahrzeug gel√∂scht', 'success');
                }
            }
            
            renderVehicleList() {
                const container = document.getElementById('vehicle-list');
                const countElement = document.getElementById('vehicle-count');
                
                countElement.textContent = this.vehicles.length;
                
                if (this.vehicles.length === 0) {
                    container.innerHTML = `
                        <div class="card" style="text-align: center; padding: 40px">
                            <div style="font-size: 48px; margin-bottom: 16px; opacity: 0.5">üöò</div>
                            <p style="color: #a0aec0; font-size: 16px">
                                Noch keine Fahrzeuge gespeichert
                            </p>
                        </div>
                    `;
                    return;
                }
                
                container.innerHTML = this.vehicles.map(vehicle => {
                    // Pr√ºfe, ob Service-Erinnerung bald f√§llig ist
                    const serviceReminder = this.getUpcomingServiceReminder(vehicle);
                    const hasUrgentService = serviceReminder && this.isReminderUrgent(serviceReminder);
                    
                    return `
                    <div class="vehicle-card" data-vehicle-id="${vehicle.id}">
                        <div style="display: flex; justify-content: space-between; align-items: flex-start">
                            <div style="flex: 1">
                                <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 6px; flex-wrap: wrap">
                                    <h3 style="color: #00d4ff; margin: 0; font-size: 18px; font-weight: bold">
                                        ${vehicle.hsn} / ${vehicle.tsn}
                                    </h3>
                                    <span style="background: rgba(157, 78, 221, 0.2); color: #e2e8f0; padding: 3px 8px; border-radius: 6px; font-size: 11px; font-weight: 600; border: 1px solid rgba(157, 78, 221, 0.4)">
                                        FIN: ${vehicle.fin}
                                    </span>
                                    ${hasUrgentService ? `
                                        <span class="warning-badge urgent-reminder">
                                            ‚ö†Ô∏è Service f√§llig
                                        </span>
                                    ` : ''}
                                </div>
                                
                                <div class="vehicle-info">
                                    ${vehicle.licensePlate ? `<span style="color: #9d4edd; font-size: 13px; font-weight: 600">üöó ${vehicle.licensePlate}</span>` : ''}
                                    ${vehicle.model ? `<span style="color: #e2e8f0; font-size: 13px">${vehicle.model}</span>` : ''}
                                    ${vehicle.mileage ? `<span style="color: #00d4ff; font-size: 13px">üìè ${vehicle.mileage} km</span>` : ''}
                                    ${vehicle.firstRegistration ? `<span style="color: #9d4edd; font-size: 13px">üìÖ ${formatDateForDisplay(vehicle.firstRegistration)}</span>` : ''}
                                </div>
                                
                                ${(vehicle.parts.length > 0 || vehicle.torqueValues.length > 0 || vehicle.images.length > 0 || vehicle.services.length > 0) ? `
                                    <div class="vehicle-info">
                                        ${vehicle.parts.length > 0 ? `<span style="color: #00d4ff; font-size: 12px">‚öôÔ∏è ${vehicle.parts.length} Teile</span>` : ''}
                                        ${vehicle.torqueValues.length > 0 ? `<span style="color: #9d4edd; font-size: 12px">üîß ${vehicle.torqueValues.length} Drehmomentwerte</span>` : ''}
                                        ${vehicle.images.length > 0 ? `<span style="color: #00d4ff; font-size: 12px">üñºÔ∏è ${vehicle.images.length} Bilder</span>` : ''}
                                        ${vehicle.services.length > 0 ? `<span style="color: #9d4edd; font-size: 12px">üöó ${vehicle.services.length} Services</span>` : ''}
                                    </div>
                                ` : ''}
                                
                                ${vehicle.nextServiceDate ? `
                                    <div class="vehicle-info">
                                        <span style="color: ${this.isServiceDueSoon(vehicle.nextServiceDate) ? '#e53e3e' : '#00d4ff'}; font-size: 12px; font-weight: 600">
                                            üîß N√§chster Service: ${formatDateForDisplay(vehicle.nextServiceDate)}
                                        </span>
                                    </div>
                                ` : ''}
                                
                                ${vehicle.notes.includes('!') ? `
                                    <div class="warning-badge">
                                        ‚ö†Ô∏è ${vehicle.notes.split('!')[1].trim()}
                                    </div>
                                ` : ''}
                            </div>
                            
                            <div class="vehicle-actions">
                                <button class="icon-button edit-button" title="Bearbeiten" style="color: #00d4ff">‚úèÔ∏è</button>
                                <button class="icon-button torque-button" title="Drehmoment" style="color: #9d4edd">üîß</button>
                                <button class="icon-button parts-button" title="Teile" style="color: #00d4ff">‚öôÔ∏è</button>
                                <button class="icon-button works-button" title="Ausgef√ºhrte Arbeiten" style="color: #00d4ff">üóìÔ∏è</button>
                                <button class="icon-button service-button" title="Service durchf√ºhren" style="color: #9d4edd">üöó</button>
                                <button class="icon-button calculator-button" title="Preisberechnung" style="color: #9d4edd">üßÆ</button>
                                <button class="icon-button detail-button" title="Details" style="color: #9d4edd">üëÅÔ∏è</button>
                                <button class="icon-button delete-button" title="L√∂schen" style="color: #e53e3e">üóëÔ∏è</button>
                            </div>
                        </div>
                    </div>
                `}).join('');
                
                // Event-Listener f√ºr die Buttons hinzuf√ºgen
                this.vehicles.forEach(vehicle => {
                    const vehicleElement = document.querySelector(`[data-vehicle-id="${vehicle.id}"]`);
                    
                    vehicleElement.querySelector('.edit-button').addEventListener('click', () => {
                        this.showEditModal(vehicle);
                    });
                    
                    vehicleElement.querySelector('.torque-button').addEventListener('click', () => {
                        this.showTorqueModal(vehicle);
                    });
                    
                    vehicleElement.querySelector('.parts-button').addEventListener('click', () => {
                        this.showPartsModal(vehicle);
                    });
                    
                    vehicleElement.querySelector('.works-button').addEventListener('click', () => {
                        this.showWorksModal(vehicle);
                    });
                    
                    vehicleElement.querySelector('.service-button').addEventListener('click', () => {
                        this.showServiceModal(vehicle);
                    });
                    
                    vehicleElement.querySelector('.calculator-button').addEventListener('click', () => {
                        this.showCalculatorModal(vehicle);
                    });
                    
                    vehicleElement.querySelector('.detail-button').addEventListener('click', () => {
                        this.showDetailModal(vehicle);
                    });
                    
                    vehicleElement.querySelector('.delete-button').addEventListener('click', () => {
                        this.deleteVehicle(vehicle.id);
                    });
                });
            }
            
            toggleRemindersPopup() {
                const popup = document.getElementById('reminders-popup');
                if (popup.classList.contains('hidden')) {
                    this.renderRemindersList();
                    popup.classList.remove('hidden');
                } else {
                    popup.classList.add('hidden');
                }
            }
            
            hideRemindersPopup() {
                document.getElementById('reminders-popup').classList.add('hidden');
            }
            
            renderRemindersList() {
                const container = document.getElementById('reminders-list');
                const reminders = loadReminders();
                
                if (reminders.length === 0) {
                    container.innerHTML = '<div style="color:#a0aec0">Keine Erinnerungen.</div>';
                    return;
                }
                
                container.innerHTML = reminders.map(reminder => {
                    const vehicle = this.vehicles.find(v => v.id === reminder.vehicleId);
                    const vehicleInfo = vehicle ? `${vehicle.hsn}/${vehicle.tsn}` : 'Unbekanntes Fahrzeug';
                    const isUrgent = this.isReminderUrgent(reminder);
                    
                    return `
                    <div class="reminder-item ${isUrgent ? 'urgent-reminder' : ''}">
                        <div>
                            <div style="color:#e2e8f0; font-weight:700">${reminder.title}</div>
                            <div style="color:#9d4edd">F√§llig: ${formatDateForDisplay(reminder.dueDate)}</div>
                            <div style="color:#a0aec0; font-size:12px">Fahrzeug: ${vehicleInfo}</div>
                        </div>
                        <div style="display:flex; flex-direction:column; gap:6px">
                            ${!reminder.done ? 
                                `<button class="complete-reminder" data-id="${reminder.id}" style="background:none; border:1px solid #00d4ff; color:#00d4ff; padding:6px; border-radius:8px">Erledigt</button>` : 
                                `<span style="color:#4ade80">Erledigt</span>`
                            }
                        </div>
                    </div>
                `}).join('');
                
                // Event-Listener f√ºr Erledigt-Buttons
                container.querySelectorAll('.complete-reminder').forEach(button => {
                    button.addEventListener('click', (e) => {
                        const id = e.target.getAttribute('data-id');
                        const updated = reminders.map(r => r.id === id ? {...r, done: true} : r);
                        saveReminders(updated);
                        this.loadReminders();
                        this.renderRemindersList();
                        this.updateRemindersCount();
                    });
                });
            }
            
            updateRemindersCount() {
                const count = this.reminders.filter(r => !r.done).length;
                const countElement = document.getElementById('reminders-count');
                countElement.textContent = count > 0 ? ' ' + count : '';
            }
            
            // Service-Erinnerungs-Funktionen
            getUpcomingServiceReminder(vehicle) {
                return this.reminders.find(r => 
                    r.vehicleId === vehicle.id && 
                    r.type === 'service' && 
                    !r.done
                );
            }
            
            isReminderUrgent(reminder) {
                const today = new Date();
                const dueDate = new Date(reminder.dueDate);
                const daysUntilDue = Math.ceil((dueDate - today) / (1000 * 60 * 60 * 24));
                return daysUntilDue <= 7; // Als dringend markieren, wenn weniger als 7 Tage verbleiben
            }
            
            isServiceDueSoon(serviceDate) {
                const today = new Date();
                const dueDate = new Date(serviceDate);
                const daysUntilDue = Math.ceil((dueDate - today) / (1000 * 60 * 60 * 24));
                return daysUntilDue <= 30; // Als bald f√§llig markieren, wenn weniger als 30 Tage verbleiben
            }
            
            checkUpcomingServices() {
                const today = new Date();
                const upcomingServices = [];
                
                this.vehicles.forEach(vehicle => {
                    if (vehicle.nextServiceDate) {
                        const serviceDate = new Date(vehicle.nextServiceDate);
                        const daysUntilService = Math.ceil((serviceDate - today) / (1000 * 60 * 60 * 24));
                        
                        // Erstelle Erinnerung nur, wenn Service in 30 Tagen oder weniger f√§llig ist
                        if (daysUntilService <= 30 && daysUntilService > 0) {
                            // Erstelle oder aktualisiere Erinnerung
                            const existingReminder = this.reminders.find(r => 
                                r.vehicleId === vehicle.id && 
                                r.type === 'service' && 
                                !r.done
                            );
                            
                            if (!existingReminder) {
                                // Erinnerung 30 Tage vor Service erstellen
                                const reminderDate = subtractDaysFromDate(serviceDate, 30);
                                const reminder = createReminder(
                                    vehicle.id,
                                    `Service f√§llig f√ºr ${vehicle.hsn}/${vehicle.tsn}`,
                                    reminderDate,
                                    'service'
                                );
                                this.reminders.push(reminder);
                            }
                        }
                    }
                });
                
                if (upcomingServices.length > 0) {
                    saveReminders(this.reminders);
                    this.updateRemindersCount();
                }
            }
            
            // Modal-Funktionen
            showModal(content) {
                const container = document.getElementById('modal-container');
                container.innerHTML = content;
            }
            
            hideModal() {
                const container = document.getElementById('modal-container');
                container.innerHTML = '';
                this.editingWorkId = null;
                this.editingServiceId = null;
            }
            
            showEditModal(vehicle) {
                const modalContent = this.createEditModal(vehicle);
                this.showModal(modalContent);
                this.bindEditModalEvents(vehicle);
            }
            
            showDetailModal(vehicle) {
                const modalContent = this.createDetailModal(vehicle);
                this.showModal(modalContent);
                this.bindDetailModalEvents(vehicle);
            }
            
            showTorqueModal(vehicle) {
                const modalContent = this.createTorqueModal(vehicle);
                this.showModal(modalContent);
                this.bindTorqueModalEvents(vehicle);
            }
            
            showPartsModal(vehicle) {
                const modalContent = this.createPartsModal(vehicle);
                this.showModal(modalContent);
                this.bindPartsModalEvents(vehicle);
            }
            
            showWorksModal(vehicle) {
                const modalContent = this.createWorksModal(vehicle);
                this.showModal(modalContent);
                this.bindWorksModalEvents(vehicle);
            }
            
            showServiceModal(vehicle, serviceToEdit = null) {
                const modalContent = this.createServiceModal(vehicle, serviceToEdit);
                this.showModal(modalContent);
                this.bindServiceModalEvents(vehicle, serviceToEdit);
            }
            
            showCalculatorModal(vehicle) {
                const modalContent = this.createCalculatorModal(vehicle);
                this.showModal(modalContent);
                this.bindCalculatorModalEvents(vehicle);
            }
            
            // Modal-Inhalte
            createEditModal(vehicle) {
                return `
                    <div class="modal-overlay">
                        <div class="modal-content" style="max-width: 700px">
                            <h2 style="color: #9d4edd; margin-bottom: 20px; font-size: 22px; display: flex; align-items: center; gap: 8px">
                                <span style="font-size: 24px">‚úèÔ∏è</span>
                                Fahrzeug bearbeiten
                            </h2>
                            
                            <div style="margin-bottom: 16px">
                                <label style="color: #00d4ff;">HSN (nur lesbar)</label>
                                <input type="text" value="${vehicle.hsn}" readonly class="input" />
                            </div>
                            
                            <div style="margin-bottom: 16px">
                                <label style="color: #00d4ff;">TSN (nur lesbar)</label>
                                <input type="text" value="${vehicle.tsn}" readonly class="input" />
                            </div>
                            
                            <div style="margin-bottom: 16px">
                                <label style="color: #00d4ff;">FIN (nur lesbar)</label>
                                <input type="text" value="${vehicle.fin}" readonly class="input" />
                            </div>
                            
                            <div style="margin-bottom: 16px">
                                <label style="color: #9d4edd;">Kennzeichen</label>
                                <input type="text" id="edit-license-plate" value="${vehicle.licensePlate}" class="input" />
                            </div>
                            
                            <div style="margin-bottom: 16px">
                                <label style="color: #9d4edd;">Modell</label>
                                <input type="text" id="edit-model" value="${vehicle.model}" class="input" />
                            </div>
                            
                            <div style="margin-bottom: 16px">
                                <label style="color: #9d4edd;">Kilometerstand</label>
                                <input type="text" id="edit-mileage" value="${vehicle.mileage}" class="input" />
                            </div>
                            
                            <div style="margin-bottom: 20px">
                                <label style="color: #9d4edd;">Erstzulassung</label>
                                <input type="date" id="edit-first-registration" value="${vehicle.firstRegistration}" class="input" />
                            </div>
                            
                            <div style="margin-bottom: 20px">
                                <label style="color: #00d4ff;">Notizen</label>
                                <textarea id="edit-notes" class="textarea">${vehicle.notes}</textarea>
                            </div>
                            
                            <div style="display: flex; gap: 10px; margin-top: 20px">
                                <button id="save-edit" class="button button-primary" style="flex: 1">üíæ Speichern</button>
                                <button id="cancel-edit" class="button button-danger" style="flex: 1">‚úï Abbrechen</button>
                            </div>
                        </div>
                    </div>
                `;
            }
            
            createDetailModal(vehicle) {
                const vehicleReminders = loadReminders().filter(r => r.vehicleId === vehicle.id);
                
                // Filtere Services aus den ausgef√ºhrten Arbeiten
                const regularWorks = vehicle.executedWorks.filter(work => 
                    !work.description.includes('Service:')
                );
                
                return `
                    <div class="modal-overlay">
                        <div class="modal-content" style="max-width: 700px">
                            <h2 style="color: #9d4edd; margin-bottom: 20px; font-size: 22px; display: flex; align-items: center; gap: 8px">
                                <span style="font-size: 24px">üëÅÔ∏è</span>
                                Fahrzeug Details
                            </h2>
                            
                            <div style="margin-bottom: 16px">
                                <strong style="color: #00d4ff">HSN/TSN:</strong> ${vehicle.hsn} / ${vehicle.tsn}
                            </div>
                            
                            <div style="margin-bottom: 16px">
                                <strong style="color: #00d4ff">FIN:</strong> ${vehicle.fin}
                            </div>
                            
                            ${vehicle.licensePlate ? `
                                <div style="margin-bottom: 16px">
                                    <strong style="color: #9d4edd">Kennzeichen:</strong> ${vehicle.licensePlate}
                                </div>
                            ` : ''}
                            
                            ${vehicle.model ? `
                                <div style="margin-bottom: 16px">
                                    <strong style="color: #9d4edd">Modell:</strong> ${vehicle.model}
                                </div>
                            ` : ''}
                            
                            ${vehicle.mileage ? `
                                <div style="margin-bottom: 16px">
                                    <strong style="color: #00d4ff">Kilometerstand:</strong> ${vehicle.mileage} km
                                </div>
                            ` : ''}
                            
                            ${vehicle.firstRegistration ? `
                                <div style="margin-bottom: 20px">
                                    <strong style="color: #9d4edd">Erstzulassung:</strong> ${formatDateForDisplay(vehicle.firstRegistration)}
                                </div>
                            ` : ''}
                            
                            ${vehicle.nextServiceDate ? `
                                <div style="margin-bottom: 20px">
                                    <strong style="color: ${this.isServiceDueSoon(vehicle.nextServiceDate) ? '#e53e3e' : '#00d4ff'}">N√§chster Service:</strong> 
                                    ${formatDateForDisplay(vehicle.nextServiceDate)}
                                    ${this.isServiceDueSoon(vehicle.nextServiceDate) ? ' ‚ö†Ô∏è (Bald f√§llig)' : ''}
                                </div>
                            ` : ''}
                            
                            ${vehicle.images.length > 0 ? `
                                <div style="margin-bottom: 20px">
                                    <h3 style="color: #00d4ff; margin-bottom: 12px; font-size: 18px; display: flex; align-items: center; gap: 8px">
                                        üñºÔ∏è Bilder (${vehicle.images.length})
                                    </h3>
                                    <div class="image-preview-container">
                                        ${vehicle.images.map(image => `
                                            <div class="image-preview">
                                                <img src="${image.data}" alt="${image.name}" style="cursor: pointer" onclick="window.open('${image.data}', '_blank')">
                                                <div class="image-filename">${image.name}</div>
                                            </div>
                                        `).join('')}
                                    </div>
                                </div>
                            ` : ''}
                            
                            ${vehicle.torqueValues.length > 0 ? `
                                <div style="margin-bottom: 20px">
                                    <h3 style="color: #00d4ff; margin-bottom: 12px; font-size: 18px; display: flex; align-items: center; gap: 8px">
                                        üîß Drehmoment Werte (${vehicle.torqueValues.length})
                                    </h3>
                                    ${vehicle.torqueValues.map(torque => `
                                        <div class="item-entry">
                                            <div class="item-details">
                                                <div class="item-title">${torque.description}</div>
                                                <div class="item-value">${torque.value}</div>
                                            </div>
                                        </div>
                                    `).join('')}
                                </div>
                            ` : ''}
                            
                            ${vehicle.parts.length > 0 ? `
                                <div style="margin-bottom: 20px">
                                    <h3 style="color: #00d4ff; margin-bottom: 12px; font-size: 18px; display: flex; align-items: center; gap: 8px">
                                        ‚öôÔ∏è Teile (${vehicle.parts.length})
                                    </h3>
                                    ${vehicle.parts.map(part => `
                                        <div class="item-entry">
                                            <div class="item-details">
                                                <div class="item-title">${part.description}</div>
                                                <div class="item-value">OE-Nummer: ${part.oeNumber}</div>
                                            </div>
                                        </div>
                                    `).join('')}
                                </div>
                            ` : ''}
                            
                            ${regularWorks.length > 0 ? `
                                <div style="margin-bottom: 20px">
                                    <h3 style="color: #00d4ff; margin-bottom: 12px; font-size: 18px">
                                        Ausgef√ºhrte Arbeiten (${regularWorks.length})
                                    </h3>
                                    ${regularWorks.map(work => `
                                        <div class="item-entry">
                                            <div class="item-details">
                                                <div class="item-title">${work.description}</div>
                                                <div class="item-value">Datum: ${formatDateForDisplay(work.date)}</div>
                                            </div>
                                        </div>
                                    `).join('')}
                                </div>
                            ` : ''}
                            
                            ${vehicle.services.length > 0 ? `
                                <div style="margin-bottom: 20px">
                                    <h3 style="color: #00d4ff; margin-bottom: 12px; font-size: 18px">
                                        Services (${vehicle.services.length})
                                    </h3>
                                    ${vehicle.services.map(service => {
                                        const completedItems = Object.entries(service.items).filter(([_, value]) => value === 'yes');
                                        const completedItemsNames = completedItems.map(([key, _]) => {
                                            const item = SERVICE_ITEMS.find(si => si.id === key);
                                            return item ? item.name : key;
                                        });
                                        
                                        return `
                                            <div class="item-entry">
                                                <div class="item-details">
                                                    <div class="item-title">Service vom ${formatDateForDisplay(service.date)}</div>
                                                    <div class="item-value">Kilometer: ${service.mileage} km</div>
                                                    ${service.notes ? `<div class="work-info">Notizen: ${service.notes}</div>` : ''}
                                                    <div class="service-details">
                                                        <div class="service-detail-item">
                                                            <span class="service-detail-name">Durchgef√ºhrte Arbeiten:</span>
                                                            <span class="service-detail-value">${completedItems.length} von ${Object.keys(service.items).length}</span>
                                                        </div>
                                                        ${completedItemsNames.length > 0 ? `
                                                            <div style="margin-top: 6px">
                                                                ${completedItemsNames.map(item => `
                                                                    <div style="color: #48bb78; font-size: 11px; margin-bottom: 2px">‚úÖ ${item}</div>
                                                                `).join('')}
                                                            </div>
                                                        ` : ''}
                                                    </div>
                                                </div>
                                                <div class="service-item-actions">
                                                    <button class="service-action-button service-edit" data-service-id="${service.id}" title="Service bearbeiten">
                                                        ‚úèÔ∏è
                                                    </button>
                                                    <button class="service-action-button service-delete" data-service-id="${service.id}" title="Service l√∂schen">
                                                        üóëÔ∏è
                                                    </button>
                                                </div>
                                            </div>
                                        `;
                                    }).join('')}
                                </div>
                            ` : ''}
                            
                            ${vehicle.notes ? `
                                <div style="margin-bottom: 20px">
                                    <h3 style="color: #00d4ff; margin-bottom: 12px; font-size: 18px">Notizen</h3>
                                    <div style="padding: 12px; background: #1a202c; border-radius: 8px; margin-top: 8px; white-space: pre-wrap; border: 1px solid rgba(157, 78, 221, 0.3)">
                                        ${vehicle.notes}
                                    </div>
                                </div>
                            ` : ''}
                            
                            <div style="margin-bottom: 20px">
                                <h3 style="color: #00d4ff; margin-bottom: 12px; font-size: 18px">Erinnerungen f√ºr dieses Fahrzeug</h3>
                                ${vehicleReminders.length === 0 ? 
                                    '<div style="color: #a0aec0">Keine Erinnerungen f√ºr dieses Fahrzeug.</div>' : 
                                    vehicleReminders.map(r => `
                                        <div class="reminder-item ${this.isReminderUrgent(r) ? 'urgent-reminder' : ''}">
                                            <div>
                                                <div style="color:#00d4ff; font-weight:700">${r.title}</div>
                                                <div style="color:white">F√§llig: ${formatDateForDisplay(r.dueDate)}</div>
                                                <div style="color:#9d4edd">Erstellt: ${formatDateForDisplay(r.createdAt)}</div>
                                            </div>
                                            <div style="display:flex; flex-direction:column; gap:8px">
                                                ${!r.done ? 
                                                    `<button class="complete-vehicle-reminder" data-id="${r.id}" style="background:none; border:1px solid #00d4ff; color:#00d4ff; padding:6px; border-radius:8px">Erledigt</button>` : 
                                                    `<span style="color:#4ade80">Erledigt</span>`
                                                }
                                            </div>
                                        </div>
                                    `).join('')
                                }
                            </div>
                            
                            <button id="close-detail" class="button button-primary" style="width: 100%">‚úï Schlie√üen</button>
                        </div>
                    </div>
                `;
            }
            
            createTorqueModal(vehicle) {
                return `
                    <div class="modal-overlay">
                        <div class="modal-content">
                            <h2 style="color: #9d4edd; margin-bottom: 20px; font-size: 22px; display: flex; align-items: center; gap: 8px">
                                <span style="font-size: 24px">üîß</span>
                                Drehmoment Werte
                            </h2>
                            
                            <div class="form-row">
                                <input type="text" id="torque-description" placeholder="Beschreibung" class="input" style="flex: 2" />
                                <input type="text" id="torque-value" placeholder="Wert" class="input" style="flex: 1" />
                                <button id="add-torque" class="button button-secondary" style="padding: 8px 12px; flex: 1">+</button>
                            </div>
                            
                            <div class="item-list">
                                ${vehicle.torqueValues.map(torque => `
                                    <div class="item-entry">
                                        <div class="item-details">
                                            <div class="item-title">${torque.description}</div>
                                            <div class="item-value">${torque.value}</div>
                                        </div>
                                        <button class="delete-item" data-id="${torque.id}">‚úï</button>
                                    </div>
                                `).join('')}
                            </div>
                            
                            <div style="display: flex; gap: 10px; margin-top: 20px">
                                <button id="save-torque" class="button button-primary" style="flex: 1">üíæ Speichern</button>
                                <button id="cancel-torque" class="button button-danger" style="flex: 1">‚úï Schlie√üen</button>
                            </div>
                        </div>
                    </div>
                `;
            }
            
            createPartsModal(vehicle) {
                return `
                    <div class="modal-overlay">
                        <div class="modal-content">
                            <h2 style="color: #9d4edd; margin-bottom: 20px; font-size: 22px; display: flex; align-items: center; gap: 8px">
                                <span style="font-size: 24px">‚öôÔ∏è</span>
                                Teile
                            </h2>
                            
                            <div class="form-row">
                                <input type="text" id="part-description" placeholder="Teilbeschreibung" class="input" style="flex: 2" />
                                <input type="text" id="part-oe-number" placeholder="OE-Nummer" class="input" style="flex: 1" />
                                <button id="add-part" class="button button-secondary" style="padding: 8px 12px; flex: 1">+</button>
                            </div>
                            
                            <div class="item-list">
                                ${vehicle.parts.map(part => `
                                    <div class="item-entry">
                                        <div class="item-details">
                                            <div class="item-title">${part.description}</div>
                                            <div class="item-value">OE: ${part.oeNumber}</div>
                                        </div>
                                        <button class="delete-item" data-id="${part.id}">‚úï</button>
                                    </div>
                                `).join('')}
                            </div>
                            
                            <div style="display: flex; gap: 10px; margin-top: 20px">
                                <button id="save-parts" class="button button-primary" style="flex: 1">üíæ Speichern</button>
                                <button id="cancel-parts" class="button button-danger" style="flex: 1">‚úï Schlie√üen</button>
                            </div>
                        </div>
                    </div>
                `;
            }
            
            createWorksModal(vehicle) {
                return `
                    <div class="modal-overlay">
                        <div class="modal-content">
                            <h2 style="color: #9d4edd; margin-bottom: 12px; font-size: 20px; display: flex; align-items: center; gap: 8px">
                                <span style="font-size: 22px">üóìÔ∏è</span> Ausgef√ºhrte Arbeiten
                            </h2>
                            
                            <p style="color: #a0aec0; margin-top: 0; margin-bottom: 12px">
                                Trage hier durchgef√ºhrte Arbeiten ein.
                            </p>
                            
                            <div class="form-row">
                                <input type="text" id="work-description" placeholder="Beschreibung der Arbeit" class="input" style="flex: 2 1 200px" />
                                <input type="date" id="work-date" class="input" style="flex: 1 1 120px" />
                                <button id="add-work" class="button button-secondary" style="padding: 8px 12px; flex: 0 1 auto">+</button>
                            </div>
                            
                            <div class="item-list" id="works-list">
                                ${vehicle.executedWorks.map(work => `
                                    <div class="item-entry" data-work-id="${work.id}">
                                        <div class="item-details">
                                            <div class="item-title">${work.description}</div>
                                            <div class="item-value">Datum: ${formatDateForDisplay(work.date)}</div>
                                        </div>
                                        <div>
                                            <button class="edit-item" data-id="${work.id}" title="Bearbeiten">‚úèÔ∏è</button>
                                            <button class="delete-item" data-id="${work.id}" title="L√∂schen">‚úï</button>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                            
                            <div style="display: flex; gap: 10px; margin-top: 12px">
                                <button id="save-works" class="button button-primary" style="flex: 1">üíæ Speichern</button>
                                <button id="cancel-works" class="button button-danger" style="flex: 1">‚úï Schlie√üen</button>
                            </div>
                        </div>
                    </div>
                `;
            }
            
            createServiceModal(vehicle, serviceToEdit = null) {
                const isEditing = serviceToEdit !== null;
                const serviceDate = isEditing ? serviceToEdit.date : new Date().toISOString().split('T')[0];
                const serviceMileage = isEditing ? serviceToEdit.mileage : (vehicle.mileage || '');
                const serviceNotes = isEditing ? serviceToEdit.notes : '';
                
                // Berechne n√§chstes Service-Datum basierend auf Intervall
                const nextServiceDate = vehicle.nextServiceDate || 
                    formatDateForInput(addYearsToDate(new Date(), vehicle.serviceInterval));
                
                // Berechne Erinnerungsdatum (30 Tage vor Service)
                const reminderDate = subtractDaysFromDate(new Date(nextServiceDate), 30);
                
                return `
                    <div class="modal-overlay">
                        <div class="modal-content">
                            <h2 style="color: #9d4edd; margin-bottom: 16px; font-size: 22px; display: flex; align-items: center; gap: 8px">
                                <span style="font-size: 24px">üöó</span>
                                ${isEditing ? 'Service bearbeiten' : 'Service durchf√ºhren'}
                            </h2>
                            
                            <p style="color: #a0aec0; margin-top: 0; margin-bottom: 16px">
                                ${isEditing ? 
                                    'Bearbeiten Sie die Service-Daten:' : 
                                    'Markieren Sie, welche Service-Arbeiten durchgef√ºhrt wurden.'}
                            </p>
                            
                            <div style="margin-bottom: 16px">
                                <label style="color: #00d4ff;">Service-Datum</label>
                                <input type="date" id="service-date" class="input" value="${serviceDate}" />
                            </div>
                            
                            <div style="margin-bottom: 16px">
                                <label style="color: #00d4ff;">Kilometerstand beim Service</label>
                                <input type="text" id="service-mileage" placeholder="z.B. 152000" class="input" value="${serviceMileage}" />
                            </div>
                            
                            ${!isEditing ? `
                                <div class="service-interval">
                                    <h4>Service-Intervall festlegen</h4>
                                    <div class="interval-options">
                                        <div class="interval-option ${vehicle.serviceInterval === 1 ? 'selected' : ''}" data-interval="1">
                                            1 Jahr
                                        </div>
                                        <div class="interval-option ${vehicle.serviceInterval === 2 ? 'selected' : ''}" data-interval="2">
                                            2 Jahre
                                        </div>
                                    </div>
                                    <div class="next-service-info">
                                        <h5>N√§chster Service</h5>
                                        <div class="next-service-details">
                                            <div>Datum: ${formatDateForDisplay(nextServiceDate)}</div>
                                            <div>Erinnerung: ${formatDateForDisplay(reminderDate)} (30 Tage vorher)</div>
                                        </div>
                                    </div>
                                </div>
                            ` : ''}
                            
                            <div class="service-checklist" id="service-checklist">
                                ${SERVICE_ITEMS.map(item => {
                                    const isSelected = isEditing ? serviceToEdit.items[item.id] === 'yes' : false;
                                    return `
                                    <div class="service-item" data-item-id="${item.id}">
                                        <div class="service-item-name">${item.name}</div>
                                        <div class="service-toggle">
                                            <div class="toggle-option yes ${isSelected ? 'selected' : ''}" data-value="yes">Ja</div>
                                            <div class="toggle-option no ${!isSelected ? 'selected' : ''}" data-value="no">Nein</div>
                                        </div>
                                    </div>
                                `}).join('')}
                            </div>
                            
                            <div style="margin-top: 16px">
                                <label style="color: #9d4edd;">Notizen zum Service</label>
                                <textarea id="service-notes" class="textarea" placeholder="Weitere Bemerkungen zum Service...">${serviceNotes}</textarea>
                            </div>
                            
                            <div class="service-summary" id="service-summary" style="display: none">
                                <h4>Service-Zusammenfassung</h4>
                                <div class="service-summary-list" id="service-summary-list"></div>
                            </div>
                            
                            <div class="service-modal-actions">
                                <button id="save-service" class="service-modal-button service-save" title="${isEditing ? '√Ñnderungen speichern' : 'Service speichern'}">
                                    üíæ
                                </button>
                                ${isEditing ? `
                                    <button id="delete-service" class="service-modal-button service-delete-modal" title="Service l√∂schen">
                                        üóëÔ∏è
                                    </button>
                                ` : ''}
                                <button id="cancel-service" class="service-modal-button service-cancel" title="Abbrechen">
                                    ‚úï
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }
            
            createCalculatorModal(vehicle) {
                const vehicleCalculations = this.priceCalculations.filter(pc => pc.vehicleId === vehicle.id);
                
                return `
                    <div class="modal-overlay">
                        <div class="modal-content" style="max-width: 900px">
                            <h2 style="color: #9d4edd; margin-bottom: 16px; font-size: 22px; display: flex; align-items: center; gap: 8px">
                                <span style="font-size: 24px">üßÆ</span>
                                Preisberechnung
                            </h2>
                            
                            <p style="color: #a0aec0; margin-top: 0; margin-bottom: 16px">
                                Berechnen Sie Preise f√ºr Teile inklusive Aufschlag und Arbeitswert (AW).
                            </p>
                            
                            <div class="calculator-actions">
                                <button id="add-calculator-row" class="button button-secondary button-small">
                                    <span style="font-size: 16px">‚ûï</span>
                                    Zeile hinzuf√ºgen
                                </button>
                                <button id="clear-calculator" class="button button-danger button-small">
                                    <span style="font-size: 16px">üóëÔ∏è</span>
                                    Alle l√∂schen
                                </button>
                            </div>
                            
                            <div style="overflow-x: auto; margin-top: 16px">
                                <table class="calculator-table">
                                    <thead>
                                        <tr>
                                            <th style="width: 30%">Teile Bezeichnung</th>
                                            <th style="width: 15%">Preis (‚Ç¨)</th>
                                            <th style="width: 15%">+20% (‚Ç¨)</th>
                                            <th style="width: 15%">AW</th>
                                            <th style="width: 15%">Gesamt (‚Ç¨)</th>
                                            <th style="width: 10%">Aktion</th>
                                        </tr>
                                    </thead>
                                    <tbody id="calculator-table-body">
                                        <tr>
                                            <td><input type="text" class="calculator-input part-name" placeholder="Teilebezeichnung"></td>
                                            <td><input type="number" class="calculator-input price-input" placeholder="0.00" step="0.01" min="0"></td>
                                            <td><input type="text" class="calculator-input price-plus-20" readonly></td>
                                            <td><input type="number" class="calculator-input aw-input" placeholder="0" step="1" min="0"></td>
                                            <td><input type="text" class="calculator-input total-price" readonly></td>
                                            <td style="text-align: center">
                                                <button class="delete-item calculator-delete" style="background: none; border: none; color: #e53e3e; cursor: pointer; font-size: 14px; padding: 4px">‚úï</button>
                                            </td>
                                        </tr>
                                    </tbody>
                                    <tfoot>
                                        <tr class="calculator-total-row">
                                            <td><strong>Gesamtsumme:</strong></td>
                                            <td><input type="text" class="calculator-input" id="total-base-price" readonly></td>
                                            <td><input type="text" class="calculator-input" id="total-plus-20" readonly></td>
                                            <td><input type="text" class="calculator-input" id="total-aw" readonly></td>
                                            <td><input type="text" class="calculator-input" id="grand-total" readonly></td>
                                            <td></td>
                                        </tr>
                                    </tfoot>
                                </table>
                            </div>
                            
                            <div class="calculator-summary">
                                <h4 style="color: #9d4edd; margin-bottom: 8px">Zusammenfassung</h4>
                                <div class="calculator-summary-item">
                                    <span class="calculator-summary-label">Gesamtpreis Teile:</span>
                                    <span class="calculator-summary-value" id="summary-parts-total">0.00 ‚Ç¨</span>
                                </div>
                                <div class="calculator-summary-item">
                                    <span class="calculator-summary-label">Arbeitswert (AW):</span>
                                    <span class="calculator-summary-value" id="summary-aw">0 AW (0.00 ‚Ç¨)</span>
                                </div>
                                <div class="calculator-summary-item" style="border-top: 1px solid rgba(157, 78, 221, 0.3); padding-top: 6px; margin-top: 6px">
                                    <span class="calculator-summary-label" style="font-weight: 600">Gesamtbetrag:</span>
                                    <span class="calculator-summary-value" style="font-weight: 600; color: #00d4ff" id="summary-grand-total">0.00 ‚Ç¨</span>
                                </div>
                            </div>
                            
                            <div style="display: flex; gap: 10px; margin-top: 20px">
                                <button id="save-calculator" class="button button-primary" style="flex: 1">üíæ Berechnung speichern</button>
                                <button id="cancel-calculator" class="button button-danger" style="flex: 1">‚úï Schlie√üen</button>
                            </div>
                            
                            ${vehicleCalculations.length > 0 ? `
                                <div class="saved-calculations">
                                    <h3 style="color: #00d4ff; margin-bottom: 12px; font-size: 18px; display: flex; align-items: center; gap: 8px">
                                        <span style="font-size: 20px">üìä</span>
                                        Gespeicherte Berechnungen (${vehicleCalculations.length})
                                    </h3>
                                    ${vehicleCalculations.map(calc => `
                                        <div class="saved-calculation-item">
                                            <div class="saved-calculation-header">
                                                <div class="saved-calculation-title">${calc.title || 'Preisberechnung'}</div>
                                                <div style="display: flex; align-items: center; gap: 8px">
                                                    <span class="saved-calculation-date">${formatDateForDisplay(calc.date)}</span>
                                                    <button class="delete-calculation" data-id="${calc.id}" title="Berechnung l√∂schen">üóëÔ∏è</button>
                                                </div>
                                            </div>
                                            <table class="saved-calculation-table">
                                                <thead>
                                                    <tr>
                                                        <th>Teile</th>
                                                        <th>Preis</th>
                                                        <th>+20%</th>
                                                        <th>AW</th>
                                                        <th>Gesamt</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    ${calc.items.map(item => `
                                                        <tr>
                                                            <td>${item.partName || '-'}</td>
                                                            <td>${item.price.toFixed(2)} ‚Ç¨</td>
                                                            <td>${item.pricePlus20.toFixed(2)} ‚Ç¨</td>
                                                            <td>${item.aw}</td>
                                                            <td>${item.total.toFixed(2)} ‚Ç¨</td>
                                                        </tr>
                                                    `).join('')}
                                                    <tr class="saved-calculation-total">
                                                        <td><strong>Gesamt</strong></td>
                                                        <td><strong>${calc.totalParts.toFixed(2)} ‚Ç¨</strong></td>
                                                        <td><strong>${(calc.totalParts * 1.2).toFixed(2)} ‚Ç¨</strong></td>
                                                        <td><strong>${calc.totalAW}</strong></td>
                                                        <td><strong>${calc.grandTotal.toFixed(2)} ‚Ç¨</strong></td>
                                                    </tr>
                                                </tbody>
                                            </table>
                                        </div>
                                    `).join('')}
                                </div>
                            ` : ''}
                        </div>
                    </div>
                `;
            }
            
            // Event-Binding f√ºr Modals
            bindEditModalEvents(vehicle) {
                const editedVehicle = {...vehicle};
                
                document.getElementById('cancel-edit').addEventListener('click', () => {
                    this.hideModal();
                });
                
                document.getElementById('save-edit').addEventListener('click', () => {
                    editedVehicle.licensePlate = document.getElementById('edit-license-plate').value;
                    editedVehicle.model = document.getElementById('edit-model').value;
                    editedVehicle.mileage = document.getElementById('edit-mileage').value;
                    editedVehicle.firstRegistration = document.getElementById('edit-first-registration').value;
                    editedVehicle.notes = document.getElementById('edit-notes').value;
                    
                    this.vehicles = this.vehicles.map(v => v.id === vehicle.id ? editedVehicle : v);
                    this.saveVehicles();
                    this.renderVehicleList();
                    this.hideModal();
                    showNotification('‚úÖ Fahrzeug erfolgreich aktualisiert!', 'success');
                });
            }
            
            bindDetailModalEvents(vehicle) {
                document.getElementById('close-detail').addEventListener('click', () => {
                    this.hideModal();
                });
                
                // Event-Listener f√ºr Service-Bearbeitung (Icons)
                document.querySelectorAll('.service-edit').forEach(button => {
                    button.addEventListener('click', (e) => {
                        const serviceId = e.target.getAttribute('data-service-id');
                        const service = vehicle.services.find(s => s.id === serviceId);
                        if (service) {
                            this.hideModal();
                            this.showServiceModal(vehicle, service);
                        }
                    });
                });
                
                // Event-Listener f√ºr Service-L√∂schung (Icons)
                document.querySelectorAll('.service-delete').forEach(button => {
                    button.addEventListener('click', (e) => {
                        const serviceId = e.target.getAttribute('data-service-id');
                        this.deleteService(vehicle, serviceId);
                    });
                });
                
                // Event-Listener f√ºr Erinnerungen in der Detail-Ansicht
                document.querySelectorAll('.complete-vehicle-reminder').forEach(button => {
                    button.addEventListener('click', (e) => {
                        const id = e.target.getAttribute('data-id');
                        const reminders = loadReminders();
                        const updated = reminders.map(r => r.id === id ? {...r, done: true} : r);
                        saveReminders(updated);
                        this.loadReminders();
                        this.hideModal();
                        // Modal neu √∂ffnen um aktualisierte Daten anzuzeigen
                        this.showDetailModal(vehicle);
                    });
                });
            }
            
            deleteService(vehicle, serviceId) {
                if (confirm('‚ö†Ô∏è M√∂chten Sie diesen Service wirklich l√∂schen?')) {
                    vehicle.services = vehicle.services.filter(s => s.id !== serviceId);
                    
                    // Wenn es der letzte Service war, n√§chsten Service-Termin zur√ºcksetzen
                    if (vehicle.services.length === 0) {
                        vehicle.nextServiceDate = '';
                    }
                    
                    this.vehicles = this.vehicles.map(v => v.id === vehicle.id ? vehicle : v);
                    this.saveVehicles();
                    this.renderVehicleList();
                    this.hideModal();
                    showNotification('üóëÔ∏è Service gel√∂scht', 'success');
                }
            }
            
            bindTorqueModalEvents(vehicle) {
                const editedVehicle = {...vehicle};
                
                document.getElementById('cancel-torque').addEventListener('click', () => {
                    this.hideModal();
                });
                
                document.getElementById('add-torque').addEventListener('click', () => {
                    const description = document.getElementById('torque-description').value.trim();
                    const value = document.getElementById('torque-value').value.trim();
                    
                    if (description && value) {
                        const newTorque = new TorqueValue({ description, value });
                        editedVehicle.torqueValues.push(newTorque);
                        
                        // UI aktualisieren
                        const itemList = document.querySelector('.item-list');
                        itemList.innerHTML += `
                            <div class="item-entry">
                                <div class="item-details">
                                    <div class="item-title">${description}</div>
                                    <div class="item-value">${value}</div>
                                </div>
                                <button class="delete-item" data-id="${newTorque.id}">‚úï</button>
                            </div>
                        `;
                        
                        // Formular zur√ºcksetzen
                        document.getElementById('torque-description').value = '';
                        document.getElementById('torque-value').value = '';
                        
                        // Event-Listener f√ºr Delete-Button hinzuf√ºgen
                        this.bindDeleteItemEvents(editedVehicle);
                    }
                });
                
                document.getElementById('save-torque').addEventListener('click', () => {
                    this.vehicles = this.vehicles.map(v => v.id === vehicle.id ? editedVehicle : v);
                    this.saveVehicles();
                    this.renderVehicleList();
                    this.hideModal();
                    showNotification('‚úÖ Drehmomentwerte gespeichert!', 'success');
                });
                
                this.bindDeleteItemEvents(editedVehicle);
            }
            
            bindPartsModalEvents(vehicle) {
                const editedVehicle = {...vehicle};
                
                document.getElementById('cancel-parts').addEventListener('click', () => {
                    this.hideModal();
                });
                
                document.getElementById('add-part').addEventListener('click', () => {
                    const description = document.getElementById('part-description').value.trim();
                    const oeNumber = document.getElementById('part-oe-number').value.trim();
                    
                    if (description && oeNumber) {
                        const newPart = new Part({ description, oeNumber });
                        editedVehicle.parts.push(newPart);
                        
                        // UI aktualisieren
                        const itemList = document.querySelector('.item-list');
                        itemList.innerHTML += `
                            <div class="item-entry">
                                <div class="item-details">
                                    <div class="item-title">${description}</div>
                                    <div class="item-value">OE: ${oeNumber}</div>
                                </div>
                                <button class="delete-item" data-id="${newPart.id}">‚úï</button>
                            </div>
                        `;
                        
                        // Formular zur√ºcksetzen
                        document.getElementById('part-description').value = '';
                        document.getElementById('part-oe-number').value = '';
                        
                        // Event-Listener f√ºr Delete-Button hinzuf√ºgen
                        this.bindDeleteItemEvents(editedVehicle);
                    }
                });
                
                document.getElementById('save-parts').addEventListener('click', () => {
                    this.vehicles = this.vehicles.map(v => v.id === vehicle.id ? editedVehicle : v);
                    this.saveVehicles();
                    this.renderVehicleList();
                    this.hideModal();
                    showNotification('‚úÖ Teileliste gespeichert!', 'success');
                });
                
                this.bindDeleteItemEvents(editedVehicle);
            }
            
            bindWorksModalEvents(vehicle) {
                const editedVehicle = {...vehicle};
                this.currentVehicle = vehicle;
                
                document.getElementById('cancel-works').addEventListener('click', () => {
                    this.hideModal();
                });
                
                document.getElementById('add-work').addEventListener('click', () => {
                    this.addNewWork(editedVehicle);
                });
                
                document.getElementById('save-works').addEventListener('click', () => {
                    this.vehicles = this.vehicles.map(v => v.id === vehicle.id ? editedVehicle : v);
                    this.saveVehicles();
                    this.renderVehicleList();
                    this.hideModal();
                    showNotification('‚úÖ Arbeiten gespeichert!', 'success');
                });
                
                // Bearbeiten-Buttons f√ºr bestehende Arbeiten
                this.bindWorkEditEvents(editedVehicle);
                
                // Delete-Buttons f√ºr bestehende Arbeiten
                this.bindDeleteItemEvents(editedVehicle);
            }
            
            bindServiceModalEvents(vehicle, serviceToEdit = null) {
                const editedVehicle = {...vehicle};
                let selectedInterval = vehicle.serviceInterval;
                const isEditing = serviceToEdit !== null;
                
                document.getElementById('cancel-service').addEventListener('click', () => {
                    this.hideModal();
                });
                
                // Event-Listener f√ºr Service-L√∂schung (nur im Bearbeitungsmodus)
                if (isEditing) {
                    document.getElementById('delete-service').addEventListener('click', () => {
                        this.deleteService(vehicle, serviceToEdit.id);
                    });
                }
                
                // Event-Listener f√ºr Service-Intervall (nur im Neuerstellungsmodus)
                if (!isEditing) {
                    document.querySelectorAll('.interval-option').forEach(option => {
                        option.addEventListener('click', (e) => {
                            document.querySelectorAll('.interval-option').forEach(opt => {
                                opt.classList.remove('selected');
                            });
                            e.target.classList.add('selected');
                            selectedInterval = parseInt(e.target.getAttribute('data-interval'));
                            
                            // Aktualisiere die Anzeige des n√§chsten Service-Datums
                            this.updateNextServiceDisplay(selectedInterval);
                        });
                    });
                }
                
                // Event-Listener f√ºr Service-Items
                const checklist = document.getElementById('service-checklist');
                checklist.addEventListener('click', (e) => {
                    if (e.target.classList.contains('toggle-option')) {
                        const serviceItem = e.target.closest('.service-item');
                        const itemId = serviceItem.getAttribute('data-item-id');
                        const value = e.target.getAttribute('data-value');
                        
                        // Alle Optionen zur√ºcksetzen
                        serviceItem.querySelectorAll('.toggle-option').forEach(option => {
                            option.classList.remove('selected');
                        });
                        
                        // Ausgew√§hlte Option markieren
                        e.target.classList.add('selected');
                        
                        // Zusammenfassung aktualisieren
                        this.updateServiceSummary();
                    }
                });
                
                document.getElementById('save-service').addEventListener('click', () => {
                    if (isEditing) {
                        this.updateService(editedVehicle, serviceToEdit);
                    } else {
                        this.saveService(editedVehicle, selectedInterval);
                    }
                });
                
                // Zusammenfassung initial anzeigen
                this.updateServiceSummary();
            }
            
            bindCalculatorModalEvents(vehicle) {
                document.getElementById('cancel-calculator').addEventListener('click', () => {
                    this.hideModal();
                });
                
                document.getElementById('add-calculator-row').addEventListener('click', () => {
                    this.addCalculatorRow();
                });
                
                document.getElementById('clear-calculator').addEventListener('click', () => {
                    if (confirm('M√∂chten Sie alle Zeilen l√∂schen?')) {
                        const tableBody = document.getElementById('calculator-table-body');
                        tableBody.innerHTML = `
                            <tr>
                                <td><input type="text" class="calculator-input part-name" placeholder="Teilebezeichnung"></td>
                                <td><input type="number" class="calculator-input price-input" placeholder="0.00" step="0.01" min="0"></td>
                                <td><input type="text" class="calculator-input price-plus-20" readonly></td>
                                <td><input type="number" class="calculator-input aw-input" placeholder="0" step="1" min="0"></td>
                                <td><input type="text" class="calculator-input total-price" readonly></td>
                                <td style="text-align: center">
                                    <button class="delete-item calculator-delete" style="background: none; border: none; color: #e53e3e; cursor: pointer; font-size: 14px; padding: 4px">‚úï</button>
                                </td>
                            </tr>
                        `;
                        this.bindCalculatorRowEvents();
                        this.updateCalculatorTotals();
                    }
                });
                
                document.getElementById('save-calculator').addEventListener('click', () => {
                    this.saveCalculatorData(vehicle);
                });
                
                // Event-Listener f√ºr L√∂schen-Buttons der gespeicherten Berechnungen
                document.querySelectorAll('.delete-calculation').forEach(button => {
                    button.addEventListener('click', (e) => {
                        const calculationId = e.target.getAttribute('data-id');
                        this.deletePriceCalculation(vehicle, calculationId);
                    });
                });
                
                // Initial Event-Listener f√ºr die erste Zeile
                this.bindCalculatorRowEvents();
            }
            
            addCalculatorRow() {
                const tableBody = document.getElementById('calculator-table-body');
                const newRow = document.createElement('tr');
                newRow.innerHTML = `
                    <td><input type="text" class="calculator-input part-name" placeholder="Teilebezeichnung"></td>
                    <td><input type="number" class="calculator-input price-input" placeholder="0.00" step="0.01" min="0"></td>
                    <td><input type="text" class="calculator-input price-plus-20" readonly></td>
                    <td><input type="number" class="calculator-input aw-input" placeholder="0" step="1" min="0"></td>
                    <td><input type="text" class="calculator-input total-price" readonly></td>
                    <td style="text-align: center">
                        <button class="delete-item calculator-delete" style="background: none; border: none; color: #e53e3e; cursor: pointer; font-size: 14px; padding: 4px">‚úï</button>
                    </td>
                `;
                tableBody.appendChild(newRow);
                this.bindCalculatorRowEvents();
            }
            
            bindCalculatorRowEvents() {
                // Event-Listener f√ºr Preis-Inputs
                document.querySelectorAll('.price-input').forEach(input => {
                    input.addEventListener('input', () => {
                        this.calculateRowTotal(input.closest('tr'));
                        this.updateCalculatorTotals();
                    });
                });
                
                // Event-Listener f√ºr AW-Inputs
                document.querySelectorAll('.aw-input').forEach(input => {
                    input.addEventListener('input', () => {
                        this.calculateRowTotal(input.closest('tr'));
                        this.updateCalculatorTotals();
                    });
                });
                
                // Event-Listener f√ºr Delete-Buttons
                document.querySelectorAll('.calculator-delete').forEach(button => {
                    button.addEventListener('click', (e) => {
                        const row = e.target.closest('tr');
                        if (document.querySelectorAll('#calculator-table-body tr').length > 1) {
                            row.remove();
                            this.updateCalculatorTotals();
                        } else {
                            // Wenn es die letzte Zeile ist, leere sie statt sie zu l√∂schen
                            row.querySelector('.part-name').value = '';
                            row.querySelector('.price-input').value = '';
                            row.querySelector('.aw-input').value = '';
                            this.calculateRowTotal(row);
                            this.updateCalculatorTotals();
                        }
                    });
                });
            }
            
            calculateRowTotal(row) {
                const priceInput = row.querySelector('.price-input');
                const awInput = row.querySelector('.aw-input');
                const pricePlus20Input = row.querySelector('.price-plus-20');
                const totalPriceInput = row.querySelector('.total-price');
                
                const price = parseFloat(priceInput.value) || 0;
                const aw = parseInt(awInput.value) || 0;
                
                // Berechne Preis + 20%
                const pricePlus20 = price * 1.2;
                
                // Berechne Gesamtpreis (Preis + 20% + AW * 3‚Ç¨)
                const awCost = aw * 3;
                const totalPrice = pricePlus20 + awCost;
                
                // Aktualisiere die Felder
                pricePlus20Input.value = pricePlus20.toFixed(2);
                totalPriceInput.value = totalPrice.toFixed(2);
            }
            
            updateCalculatorTotals() {
                let totalBasePrice = 0;
                let totalPlus20 = 0;
                let totalAW = 0;
                let grandTotal = 0;
                
                document.querySelectorAll('#calculator-table-body tr').forEach(row => {
                    const price = parseFloat(row.querySelector('.price-input').value) || 0;
                    const aw = parseInt(row.querySelector('.aw-input').value) || 0;
                    const pricePlus20 = price * 1.2;
                    const rowTotal = pricePlus20 + (aw * 3);
                    
                    totalBasePrice += price;
                    totalPlus20 += pricePlus20;
                    totalAW += aw;
                    grandTotal += rowTotal;
                });
                
                // Aktualisiere die Gesamtfelder
                document.getElementById('total-base-price').value = totalBasePrice.toFixed(2);
                document.getElementById('total-plus-20').value = totalPlus20.toFixed(2);
                document.getElementById('total-aw').value = totalAW;
                document.getElementById('grand-total').value = grandTotal.toFixed(2);
                
                // Aktualisiere die Zusammenfassung (ohne Aufschlag 20% separat)
                document.getElementById('summary-parts-total').textContent = totalPlus20.toFixed(2) + ' ‚Ç¨';
                document.getElementById('summary-aw').textContent = `${totalAW} AW (${(totalAW * 3).toFixed(2)} ‚Ç¨)`;
                document.getElementById('summary-grand-total').textContent = grandTotal.toFixed(2) + ' ‚Ç¨';
            }
            
            saveCalculatorData(vehicle) {
                const calculatorData = [];
                let totalBasePrice = 0;
                let totalAW = 0;
                let grandTotal = 0;
                
                document.querySelectorAll('#calculator-table-body tr').forEach(row => {
                    const partName = row.querySelector('.part-name').value.trim();
                    const price = parseFloat(row.querySelector('.price-input').value) || 0;
                    const aw = parseInt(row.querySelector('.aw-input').value) || 0;
                    
                    if (partName || price > 0 || aw > 0) {
                        const pricePlus20 = price * 1.2;
                        const total = pricePlus20 + (aw * 3);
                        
                        calculatorData.push({
                            partName,
                            price,
                            aw,
                            pricePlus20,
                            total
                        });
                        
                        totalBasePrice += price;
                        totalAW += aw;
                        grandTotal += total;
                    }
                });
                
                if (calculatorData.length > 0) {
                    const title = prompt('Geben Sie einen Namen f√ºr diese Berechnung ein:', `Berechnung vom ${new Date().toLocaleDateString('de-DE')}`);
                    
                    if (title !== null) {
                        const newCalculation = new PriceCalculation({
                            vehicleId: vehicle.id,
                            title: title || `Berechnung vom ${new Date().toLocaleDateString('de-DE')}`,
                            items: calculatorData,
                            totalParts: totalBasePrice * 1.2, // Gesamtpreis Teile inkl. 20%
                            totalAW: totalAW,
                            grandTotal: grandTotal
                        });
                        
                        this.priceCalculations.push(newCalculation);
                        this.savePriceCalculations();
                        
                        showNotification('‚úÖ Preisberechnung gespeichert!', 'success');
                        this.hideModal();
                        // Modal neu √∂ffnen um aktualisierte Liste anzuzeigen
                        this.showCalculatorModal(vehicle);
                    }
                } else {
                    showNotification('‚ÑπÔ∏è Keine Daten zum Speichern vorhanden', 'info');
                }
            }
            
            deletePriceCalculation(vehicle, calculationId) {
                if (confirm('‚ö†Ô∏è M√∂chten Sie diese Preisberechnung wirklich l√∂schen?')) {
                    this.priceCalculations = this.priceCalculations.filter(pc => pc.id !== calculationId);
                    this.savePriceCalculations();
                    
                    showNotification('üóëÔ∏è Preisberechnung gel√∂scht', 'success');
                    this.hideModal();
                    // Modal neu √∂ffnen um aktualisierte Liste anzuzeigen
                    this.showCalculatorModal(vehicle);
                }
            }
            
            updateNextServiceDisplay(interval) {
                const serviceDate = document.getElementById('service-date').value;
                if (!serviceDate) return;
                
                const nextServiceDate = addYearsToDate(new Date(serviceDate), interval);
                const reminderDate = subtractDaysFromDate(nextServiceDate, 30);
                
                const nextServiceInfo = document.querySelector('.next-service-details');
                if (nextServiceInfo) {
                    nextServiceInfo.innerHTML = `
                        <div>Datum: ${formatDateForDisplay(nextServiceDate)}</div>
                        <div>Erinnerung: ${formatDateForDisplay(reminderDate)} (30 Tage vorher)</div>
                    `;
                }
            }
            
            updateServiceSummary() {
                const summary = document.getElementById('service-summary');
                const summaryList = document.getElementById('service-summary-list');
                const serviceItems = document.querySelectorAll('.service-item');
                
                let completedItems = [];
                
                serviceItems.forEach(item => {
                    const itemId = item.getAttribute('data-item-id');
                    const itemName = item.querySelector('.service-item-name').textContent;
                    const selectedOption = item.querySelector('.toggle-option.selected');
                    
                    if (selectedOption && selectedOption.getAttribute('data-value') === 'yes') {
                        completedItems.push(itemName);
                    }
                });
                
                if (completedItems.length > 0) {
                    summary.style.display = 'block';
                    summaryList.innerHTML = completedItems.map(item => 
                        `<div class="service-summary-item">‚úÖ ${item}</div>`
                    ).join('');
                } else {
                    summary.style.display = 'none';
                }
            }
            
            saveService(editedVehicle, interval) {
                const date = document.getElementById('service-date').value;
                const mileage = document.getElementById('service-mileage').value;
                const notes = document.getElementById('service-notes').value;
                
                if (!date) {
                    showNotification('‚ùå Bitte geben Sie ein Service-Datum ein', 'error');
                    return;
                }
                
                if (!mileage) {
                    showNotification('‚ùå Bitte geben Sie den Kilometerstand ein', 'error');
                    return;
                }
                
                // Service-Items sammeln
                const serviceItems = {};
                const serviceItemsElements = document.querySelectorAll('.service-item');
                
                serviceItemsElements.forEach(item => {
                    const itemId = item.getAttribute('data-item-id');
                    const selectedOption = item.querySelector('.toggle-option.selected');
                    const value = selectedOption ? selectedOption.getAttribute('data-value') : 'no';
                    serviceItems[itemId] = value;
                });
                
                // Neuen Service erstellen
                const newService = new Service({
                    date,
                    mileage,
                    items: serviceItems,
                    notes
                });
                
                // Service zur Liste hinzuf√ºgen
                editedVehicle.services.push(newService);
                
                // N√§chstes Service-Datum und Intervall setzen
                editedVehicle.nextServiceDate = formatDateForInput(addYearsToDate(new Date(date), interval));
                editedVehicle.serviceInterval = interval;
                
                // Erinnerung f√ºr n√§chsten Service erstellen (30 Tage vorher)
                const reminderDate = subtractDaysFromDate(new Date(editedVehicle.nextServiceDate), 30);
                const reminder = createReminder(
                    editedVehicle.id,
                    `Service f√§llig f√ºr ${editedVehicle.hsn}/${editedVehicle.tsn}`,
                    reminderDate,
                    'service'
                );
                
                // Alte Service-Erinnerungen f√ºr dieses Fahrzeug entfernen
                this.reminders = this.reminders.filter(r => 
                    !(r.vehicleId === editedVehicle.id && r.type === 'service' && !r.done)
                );
                
                // Neue Erinnerung hinzuf√ºgen
                this.reminders.push(reminder);
                saveReminders(this.reminders);
                
                // Daten speichern
                this.vehicles = this.vehicles.map(v => v.id === editedVehicle.id ? editedVehicle : v);
                this.saveVehicles();
                this.renderVehicleList();
                this.hideModal();
                
                showNotification('‚úÖ Service erfolgreich gespeichert! N√§chster Service wurde geplant.', 'success');
            }
            
            updateService(editedVehicle, serviceToEdit) {
                const date = document.getElementById('service-date').value;
                const mileage = document.getElementById('service-mileage').value;
                const notes = document.getElementById('service-notes').value;
                
                if (!date) {
                    showNotification('‚ùå Bitte geben Sie ein Service-Datum ein', 'error');
                    return;
                }
                
                if (!mileage) {
                    showNotification('‚ùå Bitte geben Sie den Kilometerstand ein', 'error');
                    return;
                }
                
                // Service-Items sammeln
                const serviceItems = {};
                const serviceItemsElements = document.querySelectorAll('.service-item');
                
                serviceItemsElements.forEach(item => {
                    const itemId = item.getAttribute('data-item-id');
                    const selectedOption = item.querySelector('.toggle-option.selected');
                    const value = selectedOption ? selectedOption.getAttribute('data-value') : 'no';
                    serviceItems[itemId] = value;
                });
                
                // Service aktualisieren
                serviceToEdit.date = date;
                serviceToEdit.mileage = mileage;
                serviceToEdit.items = serviceItems;
                serviceToEdit.notes = notes;
                
                // Daten speichern
                this.vehicles = this.vehicles.map(v => v.id === editedVehicle.id ? editedVehicle : v);
                this.saveVehicles();
                this.renderVehicleList();
                this.hideModal();
                
                showNotification('‚úÖ Service erfolgreich aktualisiert!', 'success');
            }
            
            addNewWork(editedVehicle) {
                const description = document.getElementById('work-description').value.trim();
                const date = document.getElementById('work-date').value;
                
                if (description && date) {
                    const newWork = new ExecutedWork({ 
                        description, 
                        date
                    });
                    editedVehicle.executedWorks.push(newWork);
                    
                    // UI aktualisieren
                    const worksList = document.getElementById('works-list');
                    worksList.innerHTML += `
                        <div class="item-entry" data-work-id="${newWork.id}">
                            <div class="item-details">
                                <div class="item-title">${description}</div>
                                <div class="item-value">Datum: ${formatDateForDisplay(date)}</div>
                            </div>
                            <div>
                                <button class="edit-item" data-id="${newWork.id}" title="Bearbeiten">‚úèÔ∏è</button>
                                <button class="delete-item" data-id="${newWork.id}" title="L√∂schen">‚úï</button>
                            </div>
                        </div>
                    `;
                    
                    // Formular zur√ºcksetzen
                    document.getElementById('work-description').value = '';
                    document.getElementById('work-date').value = '';
                    
                    // Event-Listener f√ºr neue Buttons hinzuf√ºgen
                    this.bindWorkEditEvents(editedVehicle);
                    this.bindDeleteItemEvents(editedVehicle);
                }
            }
            
            bindWorkEditEvents(editedVehicle) {
                document.querySelectorAll('.edit-item').forEach(button => {
                    button.addEventListener('click', (e) => {
                        const workId = e.target.getAttribute('data-id');
                        this.editWork(workId, editedVehicle);
                    });
                });
            }
            
            editWork(workId, editedVehicle) {
                const work = editedVehicle.executedWorks.find(w => w.id === workId);
                if (!work) return;
                
                this.editingWorkId = workId;
                
                // Bearbeitungsformular erstellen
                const workElement = document.querySelector(`[data-work-id="${workId}"]`);
                
                const editForm = `
                    <div class="work-edit-form">
                        <div class="form-row">
                            <input type="text" id="edit-work-description" value="${work.description}" class="input" style="flex: 2 1 200px" placeholder="Beschreibung" />
                            <input type="date" id="edit-work-date" value="${work.date}" class="input" style="flex: 1 1 120px" />
                        </div>
                        <div class="work-actions">
                            <button class="button button-success button-small save-edit-work" style="padding: 6px 12px;">üíæ Speichern</button>
                            <button class="button button-danger button-small cancel-edit-work" style="padding: 6px 12px;">‚úï Abbrechen</button>
                        </div>
                    </div>
                `;
                
                workElement.innerHTML = editForm;
                
                // Event-Listener f√ºr Bearbeitungsformular
                document.querySelector('.save-edit-work').addEventListener('click', () => {
                    this.saveWorkEdit(workId, editedVehicle);
                });
                
                document.querySelector('.cancel-edit-work').addEventListener('click', () => {
                    this.cancelWorkEdit(workId, editedVehicle);
                });
            }
            
            saveWorkEdit(workId, editedVehicle) {
                const work = editedVehicle.executedWorks.find(w => w.id === workId);
                if (!work) return;
                
                const newDescription = document.getElementById('edit-work-description').value.trim();
                const newDate = document.getElementById('edit-work-date').value;
                
                if (newDescription && newDate) {
                    // Arbeit aktualisieren
                    work.description = newDescription;
                    work.date = newDate;
                    
                    // UI aktualisieren
                    this.renderWorkItem(work, editedVehicle);
                    this.bindWorkEditEvents(editedVehicle);
                    this.bindDeleteItemEvents(editedVehicle);
                    
                    showNotification('‚úÖ Arbeit erfolgreich aktualisiert!', 'success');
                }
            }
            
            cancelWorkEdit(workId, editedVehicle) {
                const work = editedVehicle.executedWorks.find(w => w.id === workId);
                if (work) {
                    this.renderWorkItem(work, editedVehicle);
                    this.bindWorkEditEvents(editedVehicle);
                    this.bindDeleteItemEvents(editedVehicle);
                }
                this.editingWorkId = null;
            }
            
            renderWorkItem(work, editedVehicle) {
                const workElement = document.querySelector(`[data-work-id="${work.id}"]`);
                workElement.innerHTML = `
                    <div class="item-details">
                        <div class="item-title">${work.description}</div>
                        <div class="item-value">Datum: ${formatDateForDisplay(work.date)}</div>
                    </div>
                    <div>
                        <button class="edit-item" data-id="${work.id}" title="Bearbeiten">‚úèÔ∏è</button>
                        <button class="delete-item" data-id="${work.id}" title="L√∂schen">‚úï</button>
                    </div>
                `;
            }
            
            bindDeleteItemEvents(editedVehicle) {
                document.querySelectorAll('.delete-item').forEach(button => {
                    button.addEventListener('click', (e) => {
                        const id = e.target.getAttribute('data-id');
                        
                        // Aus allen Arrays entfernen
                        if (editedVehicle.torqueValues) {
                            editedVehicle.torqueValues = editedVehicle.torqueValues.filter(t => t.id !== id);
                        }
                        if (editedVehicle.parts) {
                            editedVehicle.parts = editedVehicle.parts.filter(p => p.id !== id);
                        }
                        if (editedVehicle.executedWorks) {
                            editedVehicle.executedWorks = editedVehicle.executedWorks.filter(w => w.id !== id);
                        }
                        
                        // UI aktualisieren
                        e.target.closest('.item-entry').remove();
                    });
                });
            }
        }

        // Anwendung starten
        document.addEventListener('DOMContentLoaded', () => {
            new VehicleManager();
        });
    </script>

<script>
if('serviceWorker' in navigator){
  navigator.serviceWorker.register('./service-worker.js')
    .catch(err=>console.warn('SW error',err));
}
</script>

</body>
</html>